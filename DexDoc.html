<!doctype html>
<html>
  <head>
<style>

/* PrismJS 1.22.0
https://prismjs.com/download.html#themes=prism&languages=markup+css+clike+javascript+solidity&plugins=line-numbers+autolinker+match-braces */
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
  color: black;
  background: none;
  text-shadow: 0 1px white;
  font-family: Consolas, Monaco, "Andale Mono", "Ubuntu Mono", monospace;
  font-size: 1em;
  text-align: left;
  white-space: pre;
  word-spacing: normal;
  word-break: normal;
  word-wrap: normal;
  line-height: 1.5;

  -moz-tab-size: 4;
  -o-tab-size: 4;
  tab-size: 4;

  -webkit-hyphens: none;
  -moz-hyphens: none;
  -ms-hyphens: none;
  hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
  text-shadow: none;
  background: #b3d4fc;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
  text-shadow: none;
  background: #b3d4fc;
}

@media print {
  code[class*="language-"],
  pre[class*="language-"] {
    text-shadow: none;
  }
}

/* Code blocks */
pre[class*="language-"] {
  padding: 1em;
  margin: 0.5em 0;
  overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
  background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
  padding: 0.1em;
  border-radius: 0.3em;
  white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
  color: slategray;
}

.token.punctuation {
  color: #999;
}

.token.namespace {
  opacity: 0.7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
  color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
  color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
  color: #9a6e3a;
  /* This background color was intended by the author of this theme. */
  background: hsla(0, 0%, 100%, 0.5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
  color: #07a;
}

.token.function,
.token.class-name {
  color: #dd4a68;
}

.token.regex,
.token.important,
.token.variable {
  color: #e90;
}

.token.important,
.token.bold {
  font-weight: bold;
}
.token.italic {
  font-style: italic;
}

.token.entity {
  cursor: help;
}

pre[class*="language-"].line-numbers {
  position: relative;
  padding-left: 3.8em;
  counter-reset: linenumber;
}

pre[class*="language-"].line-numbers > code {
  position: relative;
  white-space: inherit;
}

.line-numbers .line-numbers-rows {
  position: absolute;
  pointer-events: none;
  top: 0;
  font-size: 100%;
  left: -3.8em;
  width: 3em; /* works for line-numbers below 1000 lines */
  letter-spacing: -1px;
  border-right: 1px solid #999;

  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.line-numbers-rows > span {
  display: block;
  counter-increment: linenumber;
}

.line-numbers-rows > span:before {
  content: counter(linenumber);
  color: #999;
  display: block;
  padding-right: 0.8em;
  text-align: right;
}

.token a {
  color: inherit;
}
.token.punctuation.brace-hover,
.token.punctuation.brace-selected {
  outline: solid 1px;
}

.rainbow-braces .token.punctuation.brace-level-1,
.rainbow-braces .token.punctuation.brace-level-5,
.rainbow-braces .token.punctuation.brace-level-9 {
  color: #e50;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-2,
.rainbow-braces .token.punctuation.brace-level-6,
.rainbow-braces .token.punctuation.brace-level-10 {
  color: #0b3;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-3,
.rainbow-braces .token.punctuation.brace-level-7,
.rainbow-braces .token.punctuation.brace-level-11 {
  color: #26f;
  opacity: 1;
}
.rainbow-braces .token.punctuation.brace-level-4,
.rainbow-braces .token.punctuation.brace-level-8,
.rainbow-braces .token.punctuation.brace-level-12 {
  color: #e0e;
  opacity: 1;
}
</style>
<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css">

<style>

html {
  scroll-behavior: smooth;
}

body {
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: stretch;
}
h1 {
  font-size: 1.5em;
}

h2 {
  font-size: 1.32em;
}

h3 {
  font-size: 1.17em;
}

.level {
  display: flex;
  flex-direction: row;
  line-height: 1.4;
  align-items: baseline;
  position: relative;
}

.level:first-child {
  padding-top: 3rem;
}

.titleLevel .left-background  {
  padding-top: 2em;
  //border-bottom: 4px solid #e5e5ee;
}

.left, .right {
  //border: 1px solid red;
}
.left-background {
  background: #f5f5ff;
  border-right: 1px solid #e5e5ee;
  width: 34rem;
  position: absolute;
  top: 0px;
  bottom: 0px;
  left: -1px;
  z-index: -1;
  padding-left: 4em;
}

.hover-background {
  border-top: 1px solid rgb(229 229 238 / 0.8);
  border-bottom: 1px solid rgb(229 229 238 / 0.3);
  right: 0px;
  width: auto;
  background: rgb(254 255 227 / 0.1);
  position: absolute;
  top: 0px;
  bottom: 0px;
  left: -1px;
  z-index: -1;
  padding-left: 4em;
  visibility: hidden;
}

body:not(.bodyFocusing) .level:hover .hover-background {
  visibility: visible;
}

.left {
  padding-left: 4rem;
  width: 34rem;
  align-items: stretch;
  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
  text-align:right;
  flex-shrink: 0;
  flex-grow: 0;
}

.level .left {
  font-size: 1.1em;
  line-height: 1.44;
}


.lineComment {
  max-width: 80%;
  font-size:0.9em;
  text-align: right;
  background: white;
  display: inline-flex;
  flex-direction: column;
  //margin-right: calc(-1px);
  padding-top: 0.2rem;
  padding-bottom: 0.2rem;
  border: 1px solid #e5e5ee;
  border-right: none;
  padding-right: 1rem;
  padding-left: 1rem;
  margin-bottom: 2px;
  margin-left: 1rem;
  border-radius: 5px 0px 0px 5px;
}

.lineComment p {
  margin: 0
}

.blockComment {
  margin-right: 3rem;
  text-align: justify;
}

.blockComment *:not(li,code,.katex *) {
  margin-top: 0px;
  margin-bottom: 1.44em;
}

.blockComment *:last-child:not(li,code,.katex *) {
  margin-bottom: 0.72em;
}

.blockComment *:first-child:not(li,code,.katex *) {
  margin-top: 0.72em;
}

.blockComment p + ul,
.blockComment p + ol
{
  margin-top: -0.72em;
}

.blockComment ul, .blockComment ol {
  margin-bottom: 0.72em;
}

// fixme not working like I want
.blockCommont:not(:first-child) {
  margin-top: 1em;
}
.blockComment pre {
  white-space: pre-wrap;
  font-size: 0.84em;
  line-height: 1.44;
  margin-top: -1.055em;
  margin-bottom: 1.055em;
  background: hsl(240 21% 102% / 1);
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  padding-left: 0.5em;
  padding-right: 2em;
}

p code, ul code, ol code {
  background: hsl(240 21% 102% / 1);
  padding: 0.2em;
}



.right {
  position: relative;
  top: 0px;
  width: 50%;
  //padding-left: 0.5rem;
  display: flex;
} 

.right, .lines {
  line-height: 1.95;
}

.focusing {
  background: rgb(254 255 227);
}

.right:hover {
  //border: 1px solid blue;
}
.right code {
}

.codewrap {
  display: flex;
  flex-direction: row;
  transition: transform 300ms ease-in-out;
}

.focuser {
  align-self: stretch;
  flex-shrink: 0;
  font-size: 1.3rem;
  text-align: center;
  display: flex;
  flex-direction: row;
  justify-content: flex-start;
  color: white;
  z-index: 1000;
  position: absolute;
  left: 0;
  top: 0;
  width: 3.2rem;
  height: 100%;
}

.focus-icon {
  //line-height: 0.85;
  font-size: 1.5rem;
  width: 1em;
  flex-grow: 0;
  flex-shrink: 0;
}

.focus-icon:before, .focus-icon:after {
  position: absolute;
  text-align: center;
  display: block;
  left: 0;
  width: 1em;
  visibility: hidden;
  color: #797979;
}

.focus-icon:before {
  content:"↡";
  top: -1.55em;
  pointer-events: none;
}


.focus-icon:after {
  content:"↟";
  bottom: -1.45em;
  pointer-events: none;
}

body:not(.bodyFocusing) .focuser:hover,
body:not(.bodyFocusing) .focusing .focuser {
  border-top: 1px dashed #797979;
  border-bottom: 1px dashed #797979;
  cursor: pointer;
}

body:not(.bodyFocusing) .focuser:hover .focus-icon:before, 
body:not(.bodyFocusing) .focuser:hover .focus-icon:after,
body:not(.bodyFocusing) .focusing .focus-icon:before, 
body:not(.bodyFocusing) .focusing .focus-icon:after {
  visibility: visible;
}

pre {
  margin: 0;
}

.right {
  position: relative;
}
.lines {
  width: content;
  flex-shrink: 0;
  margin-right: 0;
  color: #797979;
  text-align: right;
  display: flex;
  justify-content: flex-end;
  margin-right: 1em;
}
.lines pre {
  width: 3.5em;
  pointer-events: none;
}

body {
  display: flex;
  flex-direction: row;
}

nav {
  width: 22em;
  flex-shrink: 0;
  background: hsl(240 47% 17% / 1);
  position: sticky;
  top: 0px;
  font-size: 0.9em;
  padding-top: 3rem;
  padding-bottom: 3rem;
  height: calc(100vh - 6rem);
  font-family: 'Lato', sans-serif;
  background: #f5f5ff;
  overflow-y: auto;
}

nav a {
  color: hsl(240 82% 98% / 1);
  color: black;
  display: block;
  text-decoration: none;
  line-height: 1;
  padding-left: 3rem;
}

nav a:hover {
  background: white;
}

nav a.highlight {
  background: white;
}

.toc-file {
  font-family: monospace;
  font-size: 1.3em;
  padding-top: 0.7em;
  padding-bottom: 0.6em;
  border-top: 1px solid #e5e5ee;
  border-bottom: 1px solid #e5e5ee;
  background: #37718E;
  color: white;
}

* + .toc-file {
  margin-top: 2em;
}

.toc-h1 {
  font-size: 1.2em;
  font-weight: 600;
  padding-top: 0.6em;
  padding-bottom: 0.55em;
}

.toc-h2 {
  font-size: 1em;
  padding-left: 3.5rem;
  padding-top: 0.4em;
  padding-bottom: 0.4em;
}

.toc-h3 + .toc-h2 {
  margin-top: .4em;
}

.toc-h3 + .toc-h1,
.toc-h2 + .toc-h1 {
  margin-top: .4em;
}

.toc-h3 {
  font-size: 0.8em;
  padding-left: 6.5rem;
  padding-top: 0.4em;
  padding-botom: 0.6em;
}

a {
  color: black;
}

.filebreak {
  width: calc(100% - 4em - 2px);
  font-family: monospace;
  /*background: #e5e5ee;*/
  background: #37718E;
  color: white;
  text-align: left;
  font-size: 1.18em !important;
  padding-top: 0.7em;
  padding-bottom: 0.6em;
  line-height: 1 !important;
  border-top: 1px solid #e5e5ee;
  border-bottom: 1px solid #e5e5ee;
}

.katex { 
  font-size: 1em;
}
</style>
<script>

/* Bounds of DOM element, including margin */
let bounds = (el,wsy) => {
  const rect = el.getBoundingClientRect();
  const style = getComputedStyle(el);
  return {
    top: wsy + rect.top - parseInt(style.marginTop),
    bottom: wsy + rect.bottom + parseInt(style.marginBottom)
  };
};

window.addEventListener('DOMContentLoaded', () => {

  /* For future reference. The current TOC highlight fails when you scroll up into a no-headings zone. Then the highlighted heading is the one below the bottom of the viewport; it should be the one above the top of the viewport. A more complete decision tree for future implementation:
  * have an array of all heading elements, and they know their position in the array
  * have a pointer to "lowest heading above viewport lower edge ("the fold").
  * keep set of visible elements
  * when an element comes in or out of the set, run:
  lowestAboveFold = i
  point = lower above fold
  for entry in entries
    if entry.out
      if entry.too_low
        if point below or is entry
          point = entry.prev
        else ()
      else (entry.too_high)
        if nobody_visible () [???]
        else () [???]
    else (entry.in)
      if point above or is entry
        point = entry
  */

  /* Keep roughly track of currently viewed section, highlight corresponding toc in nav */
  const visibleHeadings = new Set();
  const observer = new IntersectionObserver(entries => {
    for (const entry of entries)
      visibleHeadings[entry.isIntersecting ? 'add' : 'delete'](entry.target);
    }, {threshold:0});
    const headingsSelector = Array.from({length: 2 }, (_,i) => `h${i+1}`).join(', ');
    const headings = document.querySelectorAll(headingsSelector);


    for (const heading of headings) observer.observe(heading);

    let curHeading = null;
    window.addEventListener('scroll', e => {
      let minBelow = [Infinity,null];
      for (const heading of visibleHeadings) {
        const b = heading.getBoundingClientRect().bottom;
        if (b < minBelow[0]) minBelow = [b,heading];
      }
      if (minBelow[1] !== curHeading) {
        if (minBelow[1] && curHeading) {
          document.querySelector(`a[href="#${curHeading.id}"]`).classList.remove('highlight');
        }
        if (minBelow[1]) {
          curHeading = minBelow[1];
          document.querySelector(`a[href="#${curHeading.id}"]`).classList.add('highlight');
        }
      }
    });

  /* Initialize cache _translate to 0 */
  for (const focuser of document.querySelectorAll('.codewrap')) {
    focuser._translate = 0;
  }

  /* Loop through all codewraps. Treat codewraps before t (which is a codewrap)
  * in reverse order. Stack codewraps above and below t. */
  const focus = (t) => {
    const wsy = window.scrollY; // cache value for performance, big difference in chrome
    let isBefore = true;
    const tBounds = bounds(t,wsy);
    let prevBottom = tBounds.bottom - t._translate;
    let prevTop = tBounds.top - t._translate;
    t._translate = 0;
    let befores = [];
    // apply changes after t from t downwards
    for (const cur of document.querySelectorAll(".codewrap")) {
      if (cur === t) {
        isBefore = false;
      } else if (isBefore) {
        befores.push(cur);
      } else {
        const cBounds = bounds(cur,wsy);
        const _translate = prevBottom - cBounds.top;
        cur._translate = cur._translate + _translate;
        prevBottom = prevBottom + (cBounds.bottom - cBounds.top);
      }
    }

    // apply changes before t from t upwards
    let cur;
    while ((cur = befores.pop())) {
      const cBounds = bounds(cur,wsy);
      const _translate = prevTop - cBounds.bottom;
      cur._translate = cur._translate + _translate;
      prevTop = prevTop - (cBounds.bottom - cBounds.top);
    }

    // batch changes after reading layout to avoid layout thrashing
    for (const cur of document.querySelectorAll('.codewrap')) {
      cur.style.transform = `translate(0px,${cur._translate}px)`;
    }

  };

  /* Stop focusing */
  let currentFocuser;

  const defocus = () => {
    currentFocuser.parentNode.classList.remove("focusing");
    document.body.classList.remove('bodyFocusing');
    currentFocuser = undefined;
    for (const t of document.querySelectorAll(".codewrap")) {
      t.style.transform = "translate(0px,0px)";
      t._translate = 0;
    }
  };

  /* Defocus when clicking anywhere and currently in focus */
  document.body.addEventListener('click', e => {
    if (currentFocuser) defocus();
  });

  /* Focus when clicking a focuser. Disabled when in focus.  */
  for (const focuser of document.querySelectorAll('.focuser')) {
    focuser.addEventListener('click', e => {
      if (currentFocuser) return;
      currentFocuser = e.currentTarget;
      focus(currentFocuser.parentNode.querySelector('.codewrap'));
      currentFocuser.parentNode.classList.add("focusing");
      document.body.classList.add('bodyFocusing');
      e.stopPropagation();
    });
  }
});
</script>
</head>
  <body>
    <nav>
      <a href="#structs.js" class="toc-file">structs.js</a>
      <a href="#structs.js-dex-summary" class="toc-h1">Dex Summary</a>
      <a href="#structs.js-data-stuctures" class="toc-h1">Data stuctures</a>
      <a href="#structs.js-structs" class="toc-h1">Structs</a>
      <a href="#structs.js-offer" class="toc-h2">Offer</a>
      <a href="#structs.js-offerdetail" class="toc-h2">OfferDetail</a>
      <a href="#structs.js-configuration-and-state" class="toc-h2">Configuration and state</a>
      <a href="#structs.js-writeoffer" class="toc-h2">WriteOffer</a>
      <a href="#structs.js-example" class="toc-h1">Example</a>
      <a href="#dexcommon.sol" class="toc-file">DexCommon.sol</a>
      <a href="#dexcommon.sol-structs-0" class="toc-h1">Structs</a>
      <a href="#dexcommon.sol-events" class="toc-h1">Events</a>
      <a href="#dexcommon.sol-imaker-interface" class="toc-h1">IMaker interface</a>
      <a href="#dexcommon.sol-itaker-interface" class="toc-h1">ITaker interface</a>
      <a href="#dexcommon.sol-monitor-interface" class="toc-h1">Monitor interface</a>
      <a href="#dex.sol" class="toc-file">Dex.sol</a>
      <a href="#dex.sol-state-variables" class="toc-h1">State variables</a>
      <a href="#dex.sol-dex-constructor" class="toc-h1">Dex Constructor</a>
      <a href="#dex.sol-configuration" class="toc-h1">Configuration</a>
      <a href="#dex.sol-gatekeeping" class="toc-h1">Gatekeeping</a>
      <a href="#dex.sol-public-maker-operations" class="toc-h1">Public Maker operations</a>
      <a href="#dex.sol-new-offer" class="toc-h2">New Offer</a>
      <a href="#dex.sol-update-offer" class="toc-h2">Update Offer</a>
      <a href="#dex.sol-retract-offer" class="toc-h2">Retract Offer</a>
      <a href="#dex.sol-provisioning" class="toc-h2">Provisioning</a>
      <a href="#dex.sol-public-taker-operations" class="toc-h1">Public Taker operations</a>
      <a href="#dex.sol-market-order" class="toc-h2">Market Order</a>
      <a href="#dex.sol-sniping" class="toc-h2">Sniping</a>
      <a href="#dex.sol-low-level-maker-functions" class="toc-h1">Low-level Maker functions</a>
      <a href="#dex.sol-write-offer" class="toc-h2">Write Offer</a>
      <a href="#dex.sol-find-position" class="toc-h2">Find Position</a>
      <a href="#dex.sol-better" class="toc-h2">Better</a>
      <a href="#dex.sol-low-level-taker-functions" class="toc-h1">Low-level Taker functions</a>
      <a href="#dex.sol-general-market-order" class="toc-h2">General Market Order</a>
      <a href="#dex.sol-general-snipe(s)" class="toc-h2">General Snipe(s)</a>
      <a href="#dex.sol-execute" class="toc-h2">Execute</a>
      <a href="#dex.sol-post-execute" class="toc-h2">Post execute</a>
      <a href="#dex.sol-maker-posthook" class="toc-h2">Maker Posthook</a>
      <a href="#dex.sol-low-level-offer-deletion" class="toc-h1">Low-level offer deletion</a>
      <a href="#dex.sol-penalties" class="toc-h1">Penalties</a>
      <a href="#dex.sol-get%2Fset-configuration-and-dex-state" class="toc-h1">Get/set configuration and Dex state</a>
      <a href="#dex.sol-locals" class="toc-h2">Locals</a>
      <a href="#dex.sol-globals" class="toc-h2">Globals</a>
      <a href="#dex.sol-maker-debit%2Fcredit-utility-functions" class="toc-h1">Maker debit/credit utility functions</a>
      <a href="#dex.sol-delegation-public-functions" class="toc-h1">Delegation public functions</a>
      <a href="#dex.sol-misc.-low-level-functions" class="toc-h1">Misc. low-level functions</a>
      <a href="#dex.sol-flashloans" class="toc-h1">Flashloans</a>
      <a href="#dex.sol-flashloan" class="toc-h2">Flashloan</a>
      <a href="#dex.sol-inverted-flashloan" class="toc-h2">Inverted Flashloan</a>
      <a href="#dex.sol-maker-execute" class="toc-h2">Maker Execute</a>
      <a href="#dex.sol-misc.-functions" class="toc-h2">Misc. functions</a>
      <a href="#dex.sol-abstract-functions" class="toc-h1">Abstract functions</a>
      <a href="#dex.sol-fmd-and-ftd-instanciations-of-dex" class="toc-h1">FMD and FTD instanciations of Dex</a>
    </nav>
    <main>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="structs.js" class="left filebreak">structs.js</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-dex-summary">Dex Summary</h1>
<ul>
<li>The Dex holds offer books for <code>base</code>,<code>quote</code> pairs.</li>
<li>Offers are sorted in a doubly linked list.</li>
<li>Each offer promises <code>base</code> and requests <code>quote</code>.</li>
<li>Each offer has an attached <code>maker</code> address.</li>
<li>In the normal operation mode (called FMD for Flash Maker Dex), when an offer is executed, we:
<ol>
<li>Flashloan some <code>quote</code> to the offer’s <code>maker</code>.</li>
<li>Call an arbitrary <code>execute</code> function on that address.</li>
<li>Transfer back some <code>base</code>.</li>
<li>Call back the <code>maker</code> so they can update their offers.</li>
</ol>
</li>
<li>There is an inverted operation mode (called FTD for Flash Taker Dex), the flashloan is reversed (from the maker to the taker).</li>
<li>Offer are just promises. They can fail.</li>
<li>If an offer fails to transfer the right amount back, the loan is reverted.</li>
<li>A penalty mechanism incentivizes keepers to keep the book clean of failing offers.</li>
<li>A penalty provision must be posted with each offer.</li>
<li>If the offer succeeds, the provision returns to the maker.</li>
<li>If the offer fails, the provision is given to the taker as penalty.</li>
<li>The penalty should overcompensate for the taker’s lost gas.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-data-stuctures">Data stuctures</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Struct-like data structures are stored in storage and memory as 256 bits words. We avoid using structs due to significant gas savings gained by extracting data from words only when needed. To make development easier, we use the preprocessor <code>solpp</code> and generate getters and setters for each struct we declare. The generation is defined in <code>lib/preproc.js</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>25
26
27</pre></code>
          <pre><br><span class="token keyword">const</span> preproc <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./lib/preproc.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Struct fields that are common to multiple structs are factored here. Multiple field names refer to offer identifiers, so the <code>id</code> field is a function that takes a name as argument.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>29
30
31
32
33
34
35
36
37
38
39
40
41
42</pre></code>
          <pre><br><span class="token keyword">const</span> fields <span class="token operator">=</span> <span class="token punctuation">{</span><br>  gives<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gives"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">96</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  wants<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"wants"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">96</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  gasprice<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasprice"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  gasreq<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasreq"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  overhead_gasbase<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"overhead_gasbase"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  offer_gasbase<span class="token operator">:</span> <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"offer_gasbase"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> <span class="token function-variable function">id_field</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">{</span> name<span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-structs">Structs</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-offer"><code>Offer</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>Offer</code>s hold the doubly-linked list pointers as well as price and volume information. 256 bits wide, so one storage read is enough. They have the following fields:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>49
50</pre></code>
          <pre><span class="token keyword">const</span> structs <span class="token operator">=</span> <span class="token punctuation">{</span><br>  offer<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>prev</code> points to immediately better offer. The best offer’s <code>prev</code> is 0. <em>24 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>52
53</pre></code>
          <pre><br>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"prev"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>next</code> points to the immediately worse offer. The worst offer’s <code>next</code> is 0. <em>24 bits wide</em>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>55</pre></code>
          <pre>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"next"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gives</code> is the amount of <code>base</code> the offer will give if successfully executed.
<em>96 bits wide</em>, so assuming the usual 18 decimals, amounts can only go up to
10 billions.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>59</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gives<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>wants</code> is the amount of <code>quote</code> the offer wants in exchange for <code>gives</code>.
<em>96 bits wide</em>, so assuming the usual 18 decimals, amounts can only go up to
10 billions.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>63</pre></code>
          <pre>    fields<span class="token punctuation">.</span>wants<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasprice</code> is in gwei/gas and <em>16 bits wide</em>, which accomodates 1 to ~65k gwei / gas.  <code>gasprice</code> is also the name of a global Dex parameter. When an offer is created, the offer’s <code>gasprice</code> is set to the max of the user-specified <code>gasprice</code> and the Dex’s global <code>gasprice</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>65
66
67</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-offerdetail"><code>OfferDetail</code></h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>OfferDetail</code>s hold the maker’s address and provision/penalty-related information.
They have the following fields:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>72</pre></code>
          <pre>  offerDetail<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>maker</code> is the address that created the offer. It will be called when the offer is executed, and later during the posthook phase.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>74</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"maker"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"address"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasreq</code> gas will be provided to <code>execute</code>. <em>24 bits wide</em>, 33% more than the block limit as of late 2020. Note that if more room was needed, we could bring it down to 16 bits and have it represent 1k gas increments.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>overhead_gasbase</code> represents the gas used by initiating an entire order (snipes or market order).
<code>offer_gasbase</code> represents the gas overhead used by processing the offer inside the Dex.</li>
</ul>
<p>The gas considered ‘used’ by an offer is the sum of</p>
<ul>
<li>gas consumed during the call to the offer</li>
<li><code>offer_gasbase</code></li>
<li><code>overhead_gasbase/n</code>, where <code>n</code> is the number of offers that failed during the entire order</li>
</ul>
<p>If an offer fails, <code>gasprice</code> wei is taken from the
provision per unit of gas used. <code>gasprice</code> should approximate the average gas
price at offer creation time.</p>
<p><code>*_gasbase</code> is <em>24 bits wide</em> – note that if more room was needed, we could bring it down to 8 bits and have it represent 1k gas increments.</p>
<p><code>*_gasbase</code> are also the names of global Dex
parameters. When an offer is created, their current value is copied from the Dex global configuration.  The maker does not choose it.</p>
<p>So, when an offer is created, the maker is asked to provision the
following amount of wei:</p>
<pre><code>(gasreq + offer_gasbase + overhead_gasbase) * gasprice
</code></pre>
<p>When an offer fails, the following amount is given to the taker as compensation:</p>
<pre><code>(gasused + offer_gasbase + overhead_gasbase/n) * gasprice
</code></pre>
<p>where <code>n</code> is the number of failing offers, and the rest is given back to the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>110
111
112
113</pre></code>
          <pre>    fields<span class="token punctuation">.</span>overhead_gasbase<span class="token punctuation">,</span><br>    fields<span class="token punctuation">.</span>offer_gasbase<span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-configuration-and-state">Configuration and state</h2>
<p>Most configuration and state information for a <code>base</code>,<code>quote</code> pair is either in a <code>global</code> struct (common to all pairs), or in a <code>local</code> struct. All state variable can be found at the beginning of the <code>Dex</code> contract in <code>Dex.sol</code>. Configuration fields are:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Global Configuration</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>118</pre></code>
          <pre>  global<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>The <code>monitor</code> can provide realtime values for <code>gasprice</code> and <code>density</code> to the dex, and receive liquidity events notifications.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>120</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"monitor"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">160</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"address"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>useOracle</code> is true, the dex will use the monitor address as an oracle for <code>gasprice</code> and <code>density</code>, for every base/quote pair.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>122</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"useOracle"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>notify</code> is true, the dex will notify the monitor address after every offer execution.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>124</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"notify"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>The <code>gasprice</code> is the amount of penalty paid by failed offers, in wei per gas used. <code>gasprice</code> should approximate the average gas price and will be subject to regular updates.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>126</pre></code>
          <pre>    fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>gasmax</code> specifies how much gas an offer may ask for at execution time. An offer which asks for more gas than the block limit would live forever on the book. Nobody could take it or remove it, except its creator (who could cancel it). In practice, we will set this parameter to a reasonable limit taking into account both practical transaction sizes and the complexity of maker contracts.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>129</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"gasmax"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">24</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>dead</code> dexes cannot be resurrected.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>131
132
133</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"dead"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Local configuration</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>135</pre></code>
          <pre>  local<span class="token operator">:</span> <span class="token punctuation">[</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>A <code>base</code>,<code>quote</code> pair is in<code>active</code> by default, but may be activated/deactivated by governance.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>137</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"active"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>fee</code>, in basis points, of <code>base</code> given to the taker. This fee is sent to the Dex. Fee is capped to 5% (see Dex.sol).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>139</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"fee"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>density</code> is similar to a ‘dust’ parameter. We prevent spamming of low-volume offers by asking for a minimum ‘density’ in <code>base</code> per gas requested. For instance, if <code>density == 10</code>, <code>offer_gasbase == 5000</code>, <code>overhead_gasbase == 0</code>, an offer with <code>gasreq == 30000</code> must promise at least <em>10 × (30000 + 5) = 305000</em> <code>base</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>141</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"density"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>overhead_gasbase</code> is an overapproximation of the gas overhead consumed by making an order (snipes or market order). Local to a pair because the costs of paying the fee depends on the relevant ERC20 contract.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>143</pre></code>
          <pre>    fields<span class="token punctuation">.</span>overhead_gasbase<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>offer_gasbase</code> is an overapproximation of the gas overhead associated with processing one offer. The Dex considers that a failed offer has used at least <code>offer_gasbase</code> gas. Local to a pair because the costs of calling <code>base</code> and <code>quote</code>’s <code>transferFrom</code> are part of <code>offer_gasbase</code>. Should only be updated when ERC20 contracts change or when opcode prices change.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>145</pre></code>
          <pre>    fields<span class="token punctuation">.</span>offer_gasbase<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If <code>lock</code> is true, orders may not be added nor executed.</li>
</ul>
<p>Reentrancy during offer execution is not considered safe:</p>
<ul>
<li>during execution, an offer could consume other offers further up in the book, effectively frontrunning the taker currently executing the offer.</li>
<li>it could also cancel other offers, creating a discrepancy between the advertised and actual market price at no cost to the maker.</li>
<li>an offer insertion consumes an unbounded amount of gas (because it has to be correctly placed in the book).</li>
</ul>
<p>Note: An optimization in the <code>marketOrder</code> function relies on reentrancy being forbidden.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>155</pre></code>
          <pre>    <span class="token punctuation">{</span> name<span class="token operator">:</span> <span class="token string">"lock"</span><span class="token punctuation">,</span> bits<span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> type<span class="token operator">:</span> <span class="token string">"uint"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>best</code> holds the current best offer id. Has size of an id field. <em>Danger</em>: reading best inside a lock may give you a stale value.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>157</pre></code>
          <pre>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"best"</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>last</code> is a counter for offer ids, incremented every time a new offer is created. It can’t go above <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{24}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>159
160
161</pre></code>
          <pre>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"last"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="structs.js-writeoffer">WriteOffer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>writeOffer</code> packs information about an offer that was just created/updated. It is used for logging compact data.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>164
165
166
167
168
169
170
171
172</pre></code>
          <pre>  writeOffer<span class="token operator">:</span> <span class="token punctuation">[</span><br>    fields<span class="token punctuation">.</span>wants<span class="token punctuation">,</span><br>    fields<span class="token punctuation">.</span>gives<span class="token punctuation">,</span><br>    fields<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span><br>    fields<span class="token punctuation">.</span>gasreq<span class="token punctuation">,</span><br>    <span class="token function">id_field</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  <span class="token punctuation">]</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="structs.js-example">Example</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>preproc.structs_with_macros</code> generates preprocessor instruction to get/set all fields in the above structs. A preprocessor method <code>m(args)</code> is invoked in solidity code by writing <code>$$(m(args))</code>.</p>
<p>For instance, the structs object</p>
<pre><code>{
myStruct: [
 {name: &quot;a&quot;, bits: 8,  type: &quot;uint&quot;},
 {name: &quot;b&quot;, bits: 160, type: &quot;address&quot;}
]
}
</code></pre>
<p>will generate the following preprocessor macros:</p>
<ul>
<li><code>set_myStruct(ptr,values)</code>. In a context where the solidity variable <code>v</code> holds an encoded <code>myStruct</code>, it can be used with <code>$$(set_myStruct('v',[['b','msg.sender']]))</code>. Note that solidity expression are given as strings. Here : <code>$$(set_myStruct('v',[['a',256]]))</code> and in all other methods, arguments exceeding the <code>bits</code> parameter of a field will be left-truncated.</li>
<li><code>make_myStruct(values)</code>. An optimised version of <code>set_myStruct</code> where the initial value is the null word.</li>
<li><code>myStruct_a(ptr)</code>, to access the <code>a</code> field. Returns a uint. If the solidity variable <code>v</code> holds an encoded <code>myStruct</code>, it can be used with <code>$$(myStruct_a('v'))</code>.</li>
<li><code>myStruct_b(ptr)</code>, to access the <code>b</code> field. Returns an address.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>194</pre></code>
          <pre>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> preproc<span class="token punctuation">.</span><span class="token function">structs_with_macros</span><span class="token punctuation">(</span>structs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="dexcommon.sol" class="left filebreak">DexCommon.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5</pre></code>
          <pre><br><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span><br><span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dexcommon.sol-structs-0">Structs</h1>
<p>The structs defined in <code>structs.js</code> have their counterpart as solidity structs that are easy to manipulate for outside contracts / callers of view functions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">DexCommon</span> <span class="token punctuation">{</span><br>  <span class="token keyword">struct</span> <span class="token class-name">Offer</span> <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> prev<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> next<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> wants<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">struct</span> <span class="token class-name">OfferDetail</span> <span class="token punctuation">{</span><br>    <span class="token builtin">address</span> maker<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gasreq<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br>  <span class="token keyword">struct</span> <span class="token class-name">Global</span> <span class="token punctuation">{</span><br>    <span class="token builtin">address</span> monitor<span class="token punctuation">;</span><br>    <span class="token builtin">bool</span> useOracle<span class="token punctuation">;</span><br>    <span class="token builtin">bool</span> notify<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gasmax<span class="token punctuation">;</span><br>    <span class="token builtin">bool</span> dead<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">struct</span> <span class="token class-name">Local</span> <span class="token punctuation">{</span><br>    <span class="token builtin">bool</span> active<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> fee<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> density<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">;</span><br>    <span class="token builtin">bool</span> lock<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> best<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> last<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">struct</span> <span class="token class-name">Config</span> <span class="token punctuation">{</span><br>    Global global<span class="token punctuation">;</span><br>    Local local<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Some miscellaneous data types useful to <code>Dex</code> and external contracts</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>SingleOrder</code> holds data about an order-offer match in a struct. Used by <code>marketOrder</code> and <code>internalSnipes</code> (and some of their nested functions) to avoid stack too deep errors.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>53
54
55
56
57</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">SingleOrder</span> <span class="token punctuation">{</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">;</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> offer<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>wants</code>/<code>gives</code> mutate over execution. Initially the <code>wants</code>/<code>gives</code> from the taker’s pov, then actual <code>wants</code>/<code>gives</code> adjusted by offer’s price and volume.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>59
60</pre></code>
          <pre>    <span class="token builtin">uint</span> wants<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>offerDetail</code> is only populated when necessary.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>62
63
64
65
66
67
68
69
70
71
72
73</pre></code>
          <pre>    <span class="token builtin">bytes32</span> offerDetail<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> global<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> local<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">struct</span> <span class="token class-name">OrderResult</span> <span class="token punctuation">{</span><br>    <span class="token builtin">bool</span> success<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> errorCode<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dexcommon.sol-events">Events</h1>
<p>The events emitted for use by bots are listed here:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>76</pre></code>
          <pre><span class="token keyword">library</span> <span class="token class-name">DexEvents</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Emitted at the creation of the new Dex contract on the pair (<code>quote</code>, <code>base</code>)</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>78
79</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">NewDex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Dex adds or removes wei from <code>maker</code>’s account</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>81
82
83</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Credit</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">Debit</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Dex reconfiguration</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>85
86
87
88
89
90
91
92
93
94
95
96</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">SetActive</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">,</span> <span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetFee</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetGasbase</span><span class="token punctuation">(</span><span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">,</span> <span class="token builtin">uint</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetGovernance</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetMonitor</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetVault</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetUseOracle</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetNotify</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetGasmax</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetDensity</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">SetGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Offer execution</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>98
99
100
101</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Success</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>maker’s address is not logged because it can be retrieved from <code>WriteOffer</code> event using <code>offerId</code>, packed in <code>data</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>103
104
105
106
107
108
109
110</pre></code>
          <pre>    <span class="token builtin">address</span> taker<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token keyword">event</span> <span class="token function">MakerFail</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>maker’s address is not logged because it can be retrieved from <code>WriteOffer</code> event using <code>offerId</code>, packed in <code>data</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>112
113
114
115
116
117
118</pre></code>
          <pre>    <span class="token builtin">address</span> taker<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> errorCode<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> makerData<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>After <code>permit</code> and <code>approve</code></li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>120
121
122
123
124
125
126
127</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Approval</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> owner<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> spender<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> value<br>  <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Dex closure</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>129
130</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">Kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>An offer was created or updated. <code>data</code> packs <code>makerWants</code>(96), <code>makerGives</code>(96), <code>gasprice</code>(16), <code>gasreq</code>(24), <code>offerId</code>(24)</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>132
133</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">WriteOffer</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">,</span> <span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li><code>offerId</code> was present and is now removed from the book.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>135
136</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">RetractOffer</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Dead offer <code>offerId</code> is collected: provision is withdrawn and <code>offerId</code> is removed from <code>offers</code> and <code>offerDetails</code> maps</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>138
139
140</pre></code>
          <pre>  <span class="token keyword">event</span> <span class="token function">DeleteOffer</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">,</span> <span class="token builtin">uint</span> offerId<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dexcommon.sol-imaker-interface">IMaker interface</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>142</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">IMaker</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called upon offer execution. If this function reverts, Dex will not try to transfer funds. Returned data (truncated to 32 bytes) can be accessed during the call to <code>makerPosthook</code> in the <code>result.errorCode</code> field.
Reverting with a message (for further processing during posthook) should be done using low level <code>revertTrade(byte32)</code> provided in the <code>DexIt</code> library. It is not possible to reenter the order book of the traded pair whilst this function is executed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>145
146
147
148</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerTrade</span><span class="token punctuation">(</span>DexCommon<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> order<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Called after all offers of an order have been executed. Posthook of the last executed order is called first and full reentrancy into the Dex is enabled at this time. <code>order</code> recalls key arguments of the order that was processed and <code>result</code> recalls important information for updating the current offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>150
151
152
153
154
155</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerPosthook</span><span class="token punctuation">(</span><br>    DexCommon<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> order<span class="token punctuation">,</span><br>    DexCommon<span class="token punctuation">.</span>OrderResult <span class="token keyword">calldata</span> result<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dexcommon.sol-itaker-interface">ITaker interface</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>157</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">ITaker</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>FTD only: call to taker after loans went through</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>159
160
161</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">takerTrade</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>total amount of base token that was flashloaned to the taker</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>163</pre></code>
          <pre>    <span class="token builtin">uint</span> totalGot<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>total amount of quote token that should be made available</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>165
166
167
168</pre></code>
          <pre>    <span class="token builtin">uint</span> totalGives<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dexcommon.sol-monitor-interface">Monitor interface</h1>
<p>If enabled, the monitor receives notification after each offer execution and is read for each pair’s <code>gasprice</code> and <code>density</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>171
172
173
174
175
176
177
178
179
180
181</pre></code>
          <pre><span class="token keyword">interface</span> <span class="token class-name">IDexMonitor</span> <span class="token punctuation">{</span><br>  <span class="token keyword">function</span> <span class="token function">notifySuccess</span><span class="token punctuation">(</span>DexCommon<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">function</span> <span class="token function">notifyFail</span><span class="token punctuation">(</span>DexCommon<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><span class="token punctuation">;</span><br><br>  <span class="token keyword">function</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  <div class="level titleLevel">
      <div class="left-background"></div>
      <div id="dex.sol" class="left filebreak">Dex.sol</div>
  </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>2
3
4
5
6
7
8
9
10
11
12
13</pre></code>
          <pre><br><span class="token keyword">pragma</span> <span class="token keyword">solidity</span> <span class="token operator">^</span><span class="token version number">0.7.0</span><span class="token punctuation">;</span><br><span class="token keyword">pragma</span> abicoder v2<span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span><br>  ITaker<span class="token punctuation">,</span><br>  IMaker<span class="token punctuation">,</span><br>  DexCommon <span class="token keyword">as</span> DC<span class="token punctuation">,</span><br>  DexEvents<span class="token punctuation">,</span><br>  IDexMonitor<br><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./DexCommon.sol"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token string">"./interfaces.sol"</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This contract describes an orderbook-based exchange (“Dex”) where market makers <em>do not have to provision their offer</em>. See <code>structs.js</code> for a longer introduction. In a nutshell: each offer created by a maker specifies an address (<code>maker</code>) to call upon offer execution by a taker. In the normal mode of operation (‘Flash Maker’), the Dex transfers the amount to be paid by the taker to the maker, calls the maker, attempts to transfer the amount promised by the maker to the taker, and reverts if it cannot.</p>
<p>There is one Dex contract that manages all tradeable pairs. This reduces deployment costs for new pairs and makes it easier to have maker provisions for all pairs in the same place.</p>
<p>There is a secondary mode of operation (‘Flash Taker’) in which the <em>maker</em> flashloans the sold amount to the taker.</p>
<p>The Dex contract is <code>abstract</code> and accomodates both modes. Two contracts, <code>FMD</code> (Flash Maker Dex) and <code>FTD</code> (Flash Taker Dex) inherit from it, one per mode of operation.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>23</pre></code>
          <pre>abstract <span class="token keyword">contract</span> <span class="token class-name">Dex</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-state-variables">State variables</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>governance</code> address. Governance is the only address that can configure parameters.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>27
28</pre></code>
          <pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> governance<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>vault</code> address. If a pair has fees &gt;0, those fees are sent to the vault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>30
31</pre></code>
          <pre>  <span class="token builtin">address</span> <span class="token keyword">public</span> vault<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Global dex configuration, encoded in a 256 bits word. The information encoded is detailed in <code>structs.js</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>33</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">public</span> global<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Configuration mapping for each token pair. The information is also detailed in <code>structs.js</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>35
36</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">public</span> locals<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The signature of the low-level swapping function. Given at construction time by inheriting contracts. In FMD, for each offer executed, <code>FLASHLOANER</code> sends from taker to maker, then calls maker. In FTD, <code>FLASHLOANER</code> first sends from maker to taker for each offer, then calls taker once, then transfers back to each maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>38
39</pre></code>
          <pre>  <span class="token builtin">bytes4</span> immutable FLASHLOANER<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Given a <code>base</code>,<code>quote</code> pair, the mappings <code>offers</code> and <code>offerDetails</code> associate two 256 bits words to each offer id. Those words encode information detailed in <code>structs.js</code>.</p>
<p>The mapping are <code>base =&gt; quote =&gt; offerId =&gt; bytes32</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>44
45
46
47
48</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint</span> <span class="token operator">=></span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">public</span> offers<span class="token punctuation">;</span><br>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">uint</span> <span class="token operator">=></span> <span class="token builtin">bytes32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">public</span> offerDetails<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Takers may provide allowances on specific pairs, so other addresses can execute orders in their name. Allowance may be set using the usual <code>approve</code> function, or through an <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <code>permit</code>.</p>
<p>The mapping is <code>base =&gt; quote =&gt; owner =&gt; spender =&gt; allowance</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>52
53</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token keyword">public</span> allowances<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Storing nonces avoids replay attacks.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>55</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> nonces<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Following <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a>, structured data signing has <code>keccak256(&quot;Permit(address base,address quote,address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)&quot;)</code> in its prefix.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>57
58</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">public</span> <span class="token keyword">constant</span> PERMIT_TYPEHASH <span class="token operator">=</span><br>    <span class="token number">0xb7bf278e51ab1478b10530c0300f911d9ed3562fc93ab5e6593368fe23c077a2</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialized in the constructor, <code>DOMAIN_SEPARATOR</code> avoids cross-application permit reuse.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>60
61</pre></code>
          <pre>  <span class="token builtin">bytes32</span> <span class="token keyword">public</span> immutable DOMAIN_SEPARATOR<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Makers provision their possible penalties in the <code>balanceOf</code> mapping.</p>
<p>Offers specify the amount of gas they require for successful execution (<code>gasreq</code>). To minimize book spamming, market makers must provision a <em>penalty</em>, which depends on their <code>gasreq</code> and on the pair’s <code>*_gasbase</code>. This provision is deducted from their <code>balanceOf</code>. If an offer fails, part of that provision is given to the taker, as retribution. The exact amount depends on the gas used by the offer before failing.</p>
<p>The Dex keeps track of their available balance in the <code>balanceOf</code> map, which is decremented every time a maker creates a new offer, and may be modified on offer updates/cancelations/takings.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>68
69</pre></code>
          <pre>  <span class="token keyword">mapping</span><span class="token punctuation">(</span><span class="token builtin">address</span> <span class="token operator">=></span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token keyword">public</span> balanceOf<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-dex-constructor">Dex Constructor</h1>
<p>To initialize a new instance, the deployer must provide initial configuration (see <code>structs.js</code> for more on configuration parameters):</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>74</pre></code>
          <pre>  <span class="token keyword">constructor</span><span class="token punctuation">(</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>_gasprice</code> is underscored to avoid builtin <code>gasprice</code> name shadowing.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>76
77</pre></code>
          <pre>    <span class="token builtin">uint</span> _gasprice<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasmax<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>takerLends</code> determines whether the taker or maker does the flashlend. FMD initializes with <code>true</code>, FTD initializes with <code>false</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>79</pre></code>
          <pre>    <span class="token builtin">bool</span> takerLends<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Used by <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a>’s <code>DOMAIN_SEPARATOR</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>81
82
83
84</pre></code>
          <pre>    <span class="token builtin">string</span> <span class="token keyword">memory</span> contractName <span class="token comment">//+clear+</span><br>  <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">NewDex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize governance. At this stage we cannot use the <code>setGovernance</code> method since no admin is set.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>86
87
88</pre></code>
          <pre>    governance <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetGovernance</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize vault to sender’s address, and set initial gasprice and gasmax.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>90
91
92</pre></code>
          <pre>    <span class="token function">setVault</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setGasprice</span><span class="token punctuation">(</span>_gasprice<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setGasmax</span><span class="token punctuation">(</span>gasmax<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In FMD, takers lend the liquidity to the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In FTD, takers come ask the makers for liquidity.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>95
96
97
98</pre></code>
          <pre>    FLASHLOANER <span class="token operator">=</span> takerLends<br>      <span class="token operator">?</span> Dex<span class="token punctuation">.</span>flashloan<span class="token punctuation">.</span>selector<br>      <span class="token punctuation">:</span> Dex<span class="token punctuation">.</span>invertedFlashloan<span class="token punctuation">.</span>selector<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Initialize <a href="https://eips.ethereum.org/EIPS/eip-712">EIP712</a> <code>DOMAIN_SEPARATOR</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116</pre></code>
          <pre>    <span class="token builtin">uint</span> chainId<span class="token punctuation">;</span><br>    <span class="token keyword">assembly</span> <span class="token punctuation">{</span><br>      chainId <span class="token operator">:=</span> <span class="token function">chainid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    DOMAIN_SEPARATOR <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span><br>      abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><br>        <span class="token function">keccak256</span><span class="token punctuation">(</span><br>          <span class="token string">"EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"</span><br>        <span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span>contractName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token builtin">bytes</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        chainId<span class="token punctuation">,</span><br>        <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-configuration">Configuration</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns the configuration in an ABI-compatible struct. Should not be called internally, would be a huge memory copying waste. Use <code>config</code> instead.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span>DC<span class="token punctuation">.</span>Config <span class="token keyword">memory</span> ret<span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ret<span class="token punctuation">.</span>global <span class="token operator">=</span> DC<span class="token punctuation">.</span><span class="token function">Global</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      monitor<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      useOracle<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">global_useOracle</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span><br>      notify<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">global_notify</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span><br>      gasprice<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      gasmax<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">global_gasmax</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      dead<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">global_dead</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ret<span class="token punctuation">.</span>local <span class="token operator">=</span> DC<span class="token punctuation">.</span><span class="token function">Local</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>      active<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_active</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span><br>      overhead_gasbase<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      offer_gasbase<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      fee<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_fee</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      density<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_density</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      best<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      lock<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_lock</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span><br>      last<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">local_last</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Returns information about an offer in ABI-compatible structs. Do not use internally, would be a huge memory-copying waste. Use <code>offers[base][quote]</code> and <code>offerDetails[base][quote]</code> instead.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">offerInfo</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span>DC<span class="token punctuation">.</span>Offer <span class="token keyword">memory</span><span class="token punctuation">,</span> DC<span class="token punctuation">.</span>OfferDetail <span class="token keyword">memory</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    DC<span class="token punctuation">.</span>Offer <span class="token keyword">memory</span> offerStruct <span class="token operator">=</span><br>      DC<span class="token punctuation">.</span><span class="token function">Offer</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        prev<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        next<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        wants<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        gives<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        gasprice<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br><br>    DC<span class="token punctuation">.</span>OfferDetail <span class="token keyword">memory</span> offerDetailStruct <span class="token operator">=</span><br>      DC<span class="token punctuation">.</span><span class="token function">OfferDetail</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>        maker<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        gasreq<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        overhead_gasbase<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        offer_gasbase<span class="token punctuation">:</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span>offerStruct<span class="token punctuation">,</span> offerDetailStruct<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convenience function to get best offer of the given pair</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>173
174
175
176
177</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">best</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">bytes32</span> local <span class="token operator">=</span> locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Convenience function to check whether given pair is locked</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>179
180
181
182
183</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">locked</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">bytes32</span> local <span class="token operator">=</span> locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> $$<span class="token punctuation">(</span><span class="token function">local_lock</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Check whether an offer is ‘live’, that is: inserted in the order book. The Dex holds a <code>base =&gt; quote =&gt; id =&gt; bytes32</code> mapping in storage. Offer ids that are not yet assigned or that point to since-deleted offer will point to the null word. A common way to check for initialization is to add an <code>exists</code> field to a struct. In our case, liveness can be denoted by <code>offer.gives &gt; 0</code>. So we just check the <code>gives</code> field.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>185
186
187
188</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">isLive</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> offer<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-gatekeeping">Gatekeeping</h1>
<p>Gatekeeping functions are safety checks called in various places.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>unlockedMarketOnly</code> protects modifying the market while an order is in progress. Since external contracts are called during orders, allowing reentrancy would, for instance, let a market maker replace offers currently on the book with worse ones. Note that the external contracts <em>will</em> be called again after the order is complete, this time without any lock on the market.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>196
197
198
199</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">local_lock</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"dex/reentrancyLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><a id="Dex/definition/liveDexOnly"></a>
In case of emergency, the Dex can be <code>kill</code>ed. It cannot be resurrected. When a Dex is dead, the following operations are disabled :</p>
<ul>
<li>Executing an offer</li>
<li>Sending ETH to the Dex the normal way. Usual <a href="https://medium.com/@alexsherbuck/two-ways-to-force-ether-into-a-contract-1543c1311c56">shenanigans</a> are possible.</li>
<li>Creating a new offer</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>206
207
208
209</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">liveDexOnly</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_dead</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"dex/dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When the Dex is deployed, all pairs are inactive by default (since <code>locals[base][quote]</code> is 0 by default). Offers on inactive pairs cannot be taken or created. They can be updated and retracted.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>211
212
213
214
215</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _local<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span><br>    <span class="token function">liveDexOnly</span><span class="token punctuation">(</span>_global<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">local_active</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"dex/inactive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-public-maker-operations">Public Maker operations</h1>
<h2 id="dex.sol-new-offer">New Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In the Dex, makers and takers call separate functions. Market makers call <code>newOffer</code> to fill the book, and takers call functions such as <code>marketOrder</code> to consume it.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The following structs holds offer creation/update parameters in memory. This frees up stack space for local variables.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>224
225
226
227
228
229
230
231
232
233
234</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">OfferPack</span> <span class="token punctuation">{</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">;</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> wants<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gives<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> id<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gasreq<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gasprice<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> pivotId<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> global<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>used on update only</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>236
237
238</pre></code>
          <pre>    <span class="token builtin">bytes32</span> oldOffer<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The function <code>newOffer</code> is for market makers only; no match with the existing book is done. A maker specifies how much <code>quote</code> it <code>wants</code> and how much <code>base</code> it <code>gives</code>.</p>
<p>It also specify with <code>gasreq</code> how much gas should be given when executing their offer.</p>
<p><code>gasprice</code> indicates an upper bound on the gasprice at which the maker is ready to be penalised if their offer fails. Any value below the Dex’s internal <code>gasprice</code> configuration value will be ignored.</p>
<p><code>gasreq</code>, together with <code>gasprice</code>, will contribute to determining the penalty provision set aside by the Dex from the market maker’s <code>balanceOf</code> balance.</p>
<p>Offers are always inserted at the correct place in the book. This requires walking through offers to find the correct insertion point. As in <a href="https://github.com/daifoundation/maker-otc/blob/f2060c5fe12fe3da71ac98e8f6acc06bca3698f5/src/matching_market.sol#L493">Oasis</a>, the maker should find the id of an offer close to its own and provide it as <code>pivotId</code>.</p>
<p>An offer cannot be inserted in a closed market, nor when a reentrancy lock for <code>base</code>,<code>quote</code> is on.</p>
<p>No more than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{24}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span> offers can ever be created for one <code>base</code>,<code>quote</code> pair.</p>
<p>The actual contents of the function is in <code>writeOffer</code>, which is called by both <code>newOffer</code> and <code>updateOffer</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>255
256
257
258
259
260
261
262
263</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">newOffer</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> wants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gives<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> pivotId<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In preparation for calling <code>writeOffer</code>, we read the <code>base</code>,<code>quote</code> pair configuration, check for reentrancy and market liveness, fill the <code>OfferPack</code> struct and increment the <code>base</code>,<code>quote</code> pair’s <code>last</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282</pre></code>
          <pre>    OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">;</span><br>    <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    ofp<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> $$<span class="token punctuation">(</span><span class="token function">local_last</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint24</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token string">"dex/offerIdOverflow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"last"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    ofp<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>quote <span class="token operator">=</span> quote<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>wants <span class="token operator">=</span> wants<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>gives <span class="token operator">=</span> gives<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>gasreq <span class="token operator">=</span> gasreq<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> gasprice<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>pivotId <span class="token operator">=</span> pivotId<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The second parameter to writeOffer indicates that we are creating a new offer, not updating an existing one.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>284
285</pre></code>
          <pre>    <span class="token function">writeOffer</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since we locally modified a field of the local configuration (<code>last</code>), we save the change to storage. Note that <code>writeOffer</code> may have further modified the local configuration by updating the current <code>best</code> offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>287
288
289
290</pre></code>
          <pre>    locals<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span><br>    <span class="token keyword">return</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-update-offer">Update Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Very similar to <code>newOffer</code>, <code>updateOffer</code> prepares an <code>OfferPack</code> for <code>writeOffer</code>. Makers should use it for updating live offers, but also to save on gas by reusing old, already consumed offers.</p>
<p>A <code>pivotId</code> should still be given to minimise reads in the offer book. It is OK to give the offers’ own id as a pivot.</p>
<p>Gas use is minimal when:</p>
<ol>
<li>The offer does not move in the book</li>
<li>The offer does not change its <code>gasreq</code></li>
<li>The (<code>base</code>,<code>quote</code>)'s <code>*_gasbase</code> has not changed since the offer was last written</li>
<li><code>gasprice</code> has not changed since the offer was last written</li>
<li><code>gasprice</code> is greater than the Dex’s gasprice estimation</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">updateOffer</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> wants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gives<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> pivotId<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">;</span><br>    <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>global<span class="token punctuation">,</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>quote <span class="token operator">=</span> quote<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>wants <span class="token operator">=</span> wants<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>gives <span class="token operator">=</span> gives<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>id <span class="token operator">=</span> offerId<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>gasreq <span class="token operator">=</span> gasreq<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> gasprice<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>pivotId <span class="token operator">=</span> pivotId<span class="token punctuation">;</span><br>    ofp<span class="token punctuation">.</span>oldOffer <span class="token operator">=</span> offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>Save local config</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>329</pre></code>
          <pre>    <span class="token builtin">bytes32</span> oldLocal <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The second argument indicates that we are updating an existing offer, not creating a new one.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>331</pre></code>
          <pre>    <span class="token function">writeOffer</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We saved the current pair’s configuration before calling <code>writeOffer</code>, since that function may update the current <code>best</code> offer. We now check for any change to the configuration and update it if needed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>333
334
335
336
337
338</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLocal <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      locals<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> ofp<span class="token punctuation">.</span>local<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">return</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-retract-offer">Retract Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>retractOffer</code> with <code>_delete == false</code> takes the offer <code>offerId</code> out of the book. However, <code>_delete == true</code> also refunds the provision associated with the offer, and clears out the offer’s entry in <code>offers</code> and <code>offerDetails</code>. A maker can recoup some gas using <code>_delete</code>, but should be careful: a deleted offer cannot be resurrected. A trick to get the provision for an offer but still keep it resurrectable: call your offer and fail immediately.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>342
343
344
345
346
347
348
349
350
351
352
353
354
355
356</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">retractOffer</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span><br>    <span class="token builtin">bool</span> _delete<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span> local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token string">"dex/retractOffer/unauthorized"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Here, we are about to un-live an offer, so we start by taking it out of the book by stitching together its previous and next offers. Note that unconditionally calling <code>stitchOffers</code> would break the book since it would connect offers that may have since moved.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>358
359
360
361
362
363
364
365
366</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isLive</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">bytes32</span> oldLocal <span class="token operator">=</span> local<span class="token punctuation">;</span><br>      local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span><br>        base<span class="token punctuation">,</span><br>        quote<span class="token punctuation">,</span><br>        $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        local<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If calling <code>stitchOffers</code> has changed the current <code>best</code> offer, we update the storage.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>368
369
370</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldLocal <span class="token operator">!=</span> local<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> local<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the user only wants to temporarily retract the offer, we will only set its <code>gives</code> to 0.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>372
373
374
375
376</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_delete<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> offerId<span class="token punctuation">,</span> offer<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the user wants to irreversibly erase the offer and get its provision back, we compute its provision from the offer’s <code>gasprice</code>, <code>*_gasbase</code> and <code>gasreq</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>378
379
380
381
382
383
384
385
386</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>_delete<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">uint</span> provision <span class="token operator">=</span><br>        <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span><br>          $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token comment">//gasprice is 0 if offer was deprovisioned</span><br>          <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>            $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>            $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">delete</span> offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token keyword">delete</span> offerDetails<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>credit <code>balanceOf</code> and log transfer</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>388
389
390
391
392
393
394</pre></code>
          <pre>      <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> provision<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">DeleteOffer</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> offerId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">RetractOffer</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> offerId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-provisioning">Provisioning</h2>
<p>Market makers must have enough provisions for possible penalties. These provisions are in ETH. Every time a new offer is created or an offer is updated, <code>balanceOf</code> is adjusted to provision the offer’s maximum possible penalty (<code>gasprice * (gasreq + overhead_gasbase + offer_gasbase)</code>).</p>
<p>For instance, if the current <code>balanceOf</code> of a maker is 1 ether and they create an offer that requires a provision of 0.01 ethers, their <code>balanceOf</code> will be reduced to 0.99 ethers. No ethers will move; this is just an internal accounting movement to make sure the maker cannot <code>withdraw</code> the provisioned amounts.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Fund may be called with a nonzero value (hence the <code>payable</code> modifier). The provision will be given to <code>maker</code>, not <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>404
405
406
407
408
409</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">fund</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">liveDexOnly</span><span class="token punctuation">(</span>_global<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">creditWei</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A transfer with enough gas to the Dex will increase the caller’s available <code>balanceOf</code> balance. <em>You should send enough gas to execute this function when sending money to the Dex.</em></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>411
412
413
414</pre></code>
          <pre>  <span class="token function">receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">payable</span> <span class="token punctuation">{</span><br>    <span class="token function">fund</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Any provision not currently held to secure an offer’s possible penalty is available for withdrawal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>416</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">withdraw</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since we only ever send money to the caller, we do not need to provide any particular amount of gas, the caller should manage this herself.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>418
419
420
421</pre></code>
          <pre>    <span class="token function">debitWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">(</span>noRevert<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-public-taker-operations">Public Taker operations</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-market-order">Market Order</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A market order specifies a (<code>base</code>,<code>quote</code>) pair, a desired total amount of <code>base</code> (<code>takerWants</code>), and an available total amount of <code>quote</code> (<code>takerGives</code>). It returns two <code>uint</code>s: the total amount of <code>base</code> received and the total amount of <code>quote</code> spent.</p>
<p>The <code>takerGives/takerWants</code> ratio induces a maximum average price that the taker is ready to pay across all offers that will be executed during the market order. It is thus possible to execute an offer with a price worse than given as argument to <code>marketOrder</code> if some cheaper offers were executed earlier in the market order (to request a specific volume (at any price), set <code>takerWants</code> to the amount desired and <code>takerGives</code> to max uint).</p>
<p>The market order stops when <code>takerWants</code> units of <code>base</code> have been obtained, or when the price has become too high, or when the end of the book has been reached.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>433
434
435
436
437
438
439
440
441</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrder</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> takerWants<span class="token punctuation">,</span> takerGives<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The delegate version of <code>marketOrder</code> is <code>marketOrderFor</code>, which takes a <code>taker</code> address as additional argument. Penalties incurred by failed offers will still be sent to <code>msg.sender</code>, but exchanged amounts will be transferred from and to the <code>taker</code>. If the <code>msg.sender</code>’s allowance for the given <code>base</code>,<code>quote</code> and <code>taker</code> are strictly less than the total amount eventually spent by <code>taker</code>, the call will fail.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">marketOrderFor</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> taker<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span>takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span><br>      base<span class="token punctuation">,</span><br>      quote<span class="token punctuation">,</span><br>      takerWants<span class="token punctuation">,</span><br>      takerGives<span class="token punctuation">,</span><br>      taker<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-sniping">Sniping</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>snipe</code> takes a single offer <code>offerId</code> from the book. Since offers can be updated, we specify <code>takerWants</code>,<code>takerGives</code> and <code>gasreq</code>, and only execute if the offer price is acceptable and the offer’s gasreq does not exceed <code>gasreq</code>.</p>
<p>It is possible to ask for 0, so we return an additional boolean indicating if <code>offerId</code> was successfully executed. Note that we do not distinguish further between mismatched arguments/offer fields on the one hand, and an execution failure on the other. Still, a failed offer has to pay a penalty, and ultimately transaction logs explicitly mention execution failures (see <code>DexCommon.sol</code>).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">snipe</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasreq<br>  <span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">bool</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token keyword">return</span><br>      <span class="token function">generalSnipe</span><span class="token punctuation">(</span><br>        base<span class="token punctuation">,</span><br>        quote<span class="token punctuation">,</span><br>        offerId<span class="token punctuation">,</span><br>        takerWants<span class="token punctuation">,</span><br>        takerGives<span class="token punctuation">,</span><br>        gasreq<span class="token punctuation">,</span><br>        msg<span class="token punctuation">.</span>sender<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The delegate version of <code>snipe</code> is <code>snipeFor</code>, which takes a <code>taker</code> address as additional argument.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">snipeFor</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> taker<br>  <span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">bool</span> success<span class="token punctuation">,</span><br>      <span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span><br>      <span class="token builtin">uint</span> takerGave<br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span>success<span class="token punctuation">,</span> takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">generalSnipe</span><span class="token punctuation">(</span><br>      base<span class="token punctuation">,</span><br>      quote<span class="token punctuation">,</span><br>      offerId<span class="token punctuation">,</span><br>      takerWants<span class="token punctuation">,</span><br>      takerGives<span class="token punctuation">,</span><br>      gasreq<span class="token punctuation">,</span><br>      taker<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>snipes</code> executes multiple offers. It takes a <code>uint[4][]</code> as last argument, with each array element of the form <code>[offerId,takerWants,takerGives,gasreq]</code>. The return parameters are of the form <code>(successes,totalGot,totalGave)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>523
524
525
526
527
528
529
530
531
532
533
534
535
536
537</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">snipes</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> targets<br>  <span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">uint</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token function">generalSnipes</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The delegate version of <code>snipes</code> is <code>snipesFor</code>, which takes a <code>taker</code> address as additional argument.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">snipesFor</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> targets<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> taker<br>  <span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">uint</span> successes<span class="token punctuation">,</span><br>      <span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span><br>      <span class="token builtin">uint</span> takerGave<br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token punctuation">(</span>successes<span class="token punctuation">,</span> takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">generalSnipes</span><span class="token punctuation">(</span><br>      base<span class="token punctuation">,</span><br>      quote<span class="token punctuation">,</span><br>      targets<span class="token punctuation">,</span><br>      taker<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-low-level-maker-functions">Low-level Maker functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-write-offer">Write Offer</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>564
565</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">writeOffer</span><span class="token punctuation">(</span>OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">,</span> <span class="token builtin">bool</span> update<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We check all values before packing. Otherwise, for values with a lower bound (such as <code>gasprice</code>), a check could erroneously succeed on the raw value but fail on the truncated value.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>567
568
569
570</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      <span class="token builtin">uint16</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>gasprice<span class="token punctuation">,</span><br>      <span class="token string">"dex/writeOffer/gasprice/16bits"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Check <code>gasreq</code> below limit. Implies <code>gasreq</code> at most 24 bits wide, which ensures no overflow in computation of <code>provision</code> (see below).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>572
573
574
575</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      ofp<span class="token punctuation">.</span>gasreq <span class="token operator">&lt;=</span> $$<span class="token punctuation">(</span><span class="token function">global_gasmax</span><span class="token punctuation">(</span><span class="token string">"ofp.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token string">"dex/writeOffer/gasreq/tooHigh"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Make sure <code>gives &gt; 0</code> – division by 0 would throw in several places otherwise, and <code>isLive</code> relies on it.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>577</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gives <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"dex/writeOffer/gives/tooLow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Make sure that the maker is posting a ‘dense enough’ offer: the ratio of <code>base</code> offered per gas consumed must be high enough. The actual gas cost paid by the taker is overapproximated by adding <code>offer_gasbase</code> to <code>gasreq</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>579
580
581
582
583
584
585</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      ofp<span class="token punctuation">.</span>gives <span class="token operator">>=</span><br>        <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">+</span> $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span><br>          $$<span class="token punctuation">(</span><span class="token function">local_density</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token string">"dex/writeOffer/density/tooLow"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The following checks are for the maker’s convenience only.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>587
588
589</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint96</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gives<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>gives<span class="token punctuation">,</span> <span class="token string">"dex/writeOffer/gives/96bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint96</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>wants<span class="token punctuation">)</span> <span class="token operator">==</span> ofp<span class="token punctuation">.</span>wants<span class="token punctuation">,</span> <span class="token string">"dex/writeOffer/wants/96bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>gasprice</code> given by maker will be bounded below by internal gasprice estimate at offer write time. With a large enough overapproximation of the gasprice, the maker can regularly update their offer without paying for writes to their <code>balanceOf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>591
592
593
594</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasprice <span class="token operator">&lt;</span> $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"ofp.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      ofp<span class="token punctuation">.</span>gasprice <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"ofp.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Log the write offer event with some packing to save a ~1k gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616</pre></code>
          <pre>    <span class="token punctuation">{</span><br>      <span class="token builtin">bytes32</span> writeOfferData <span class="token operator">=</span><br>        $$<span class="token punctuation">(</span><br>          <span class="token function">make_writeOffer</span><span class="token punctuation">(</span><br>            <span class="token punctuation">[</span><br>              <span class="token punctuation">[</span><span class="token string">"wants"</span><span class="token punctuation">,</span> <span class="token string">"ofp.wants"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"gives"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gives"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"gasreq"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gasreq"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gasprice"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><br>            <span class="token punctuation">]</span><br>          <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">WriteOffer</span><span class="token punctuation">(</span><br>        ofp<span class="token punctuation">.</span>base<span class="token punctuation">,</span><br>        ofp<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>        msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span><br>        writeOfferData<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The position of the new or updated offer is found using <code>findPosition</code>. If the offer is the best one, <code>prev == 0</code>, and if it’s the last in the book, <code>next == 0</code>.</p>
<p><code>findPosition</code> is only ever called here, but exists as a separate function to make the code easier to read.</p>
<p><strong>Warning</strong>: <code>findPosition</code> will call <code>better</code>, which may read the offer’s <code>offerDetails</code>. So it is important to find the offer position <em>before</em> we update its <code>offerDetail</code> in storage. We waste 1 read in that case but we deem that the code would get too ugly if we passed the old offerDetail as argument to <code>findPosition</code> and to <code>better</code>, just to save 1 read in that specific case.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>622
623</pre></code>
          <pre>    <span class="token punctuation">(</span><span class="token builtin">uint</span> prev<span class="token punctuation">,</span> <span class="token builtin">uint</span> next<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">findPosition</span><span class="token punctuation">(</span>ofp<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now write the new offerDetails and remember the previous provision (0 by default, for new offers) to balance out maker’s <code>balanceOf</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640</pre></code>
          <pre>    <span class="token builtin">uint</span> oldProvision<span class="token punctuation">;</span><br>    <span class="token punctuation">{</span><br>      <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">require</span><span class="token punctuation">(</span><br>          msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>          <span class="token string">"dex/updateOffer/unauthorized"</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>        oldProvision <span class="token operator">=</span><br>          <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span><br>          $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span><br>          <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>            $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>            $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the offer is new, has a new gasreq, or if the Dex’s <code>*_gasbase</code> configuration parameter has changed, we also update offerDetails.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>642
643
644
645
646
647
648
649
650
651
652
653
654
655
656
657
658
659
660
661
662
663
664</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><br>        <span class="token operator">!</span>update <span class="token operator">||</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> ofp<span class="token punctuation">.</span>gasreq <span class="token operator">||</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span><br>        $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span><br>        $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token builtin">uint</span> overhead_gasbase <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token builtin">uint</span> offer_gasbase <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        offerDetails<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>          <span class="token function">make_offerDetail</span><span class="token punctuation">(</span><br>            <span class="token punctuation">[</span><br>              <span class="token punctuation">[</span><span class="token string">"maker"</span><span class="token punctuation">,</span> <span class="token string">"uint(msg.sender)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"gasreq"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gasreq"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"overhead_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"overhead_gasbase"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>              <span class="token punctuation">[</span><span class="token string">"offer_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"offer_gasbase"</span><span class="token punctuation">]</span><br>            <span class="token punctuation">]</span><br>          <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>With every change to an offer, a maker must deduct provisions from its <code>balanceOf</code> balance, or get some back if the updated offer requires fewer provisions.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>666
667
668
669
670
671
672
673
674
675
676
677
678</pre></code>
          <pre>    <span class="token punctuation">{</span><br>      <span class="token builtin">uint</span> provision <span class="token operator">=</span><br>        <span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>gasreq <span class="token operator">+</span><br>          $$<span class="token punctuation">(</span><span class="token function">local_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>          $$<span class="token punctuation">(</span><span class="token function">local_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span><br>          ofp<span class="token punctuation">.</span>gasprice <span class="token operator">*</span><br>          <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span><span class="token punctuation">;</span><br>      <span class="token keyword">if</span> <span class="token punctuation">(</span>provision <span class="token operator">></span> oldProvision<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">debitWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> provision <span class="token operator">-</span> oldProvision<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>provision <span class="token operator">&lt;</span> oldProvision<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">creditWei</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> oldProvision <span class="token operator">-</span> provision<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We now place the offer in the book at the position found by <code>findPosition</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>First, we test if the offer has moved in the book or is not currently in the book. If <code>next == ofp.id</code>, then the new offer parameters are strictly better than before, but still worse than its predecessor’s. If <code>prev == ofp.id</code>, then the new offer parameters are worse than before, but strictly better than its successor’s. If either is true, there’s nothing to write to storage. Otherwise:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>682</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>next <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id <span class="token operator">||</span> prev <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If the offer is not the best one, we update its predecessor; otherwise we update the <code>best</code> value.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>684
685
686
687
688
689
690
691</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>prev<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>          <span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offers[ofp.base][ofp.quote][prev]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"next"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"best"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>If the offer is not the last one, we update its successor.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>693
694
695
696
697
698</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>next<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>          <span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offers[ofp.base][ofp.quote][next]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"prev"</span><span class="token punctuation">,</span> <span class="token string">"ofp.id"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Recall that in this branch, the offer has changed location, or is not currently in the book. If the offer is not new and already in the book, we must remove it from its previous location by stitching its previous prev/next.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>700
701
702
703
704
705
706
707
708
709
710</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>update <span class="token operator">&amp;&amp;</span> <span class="token function">isLive</span><span class="token punctuation">(</span>ofp<span class="token punctuation">.</span>oldOffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        ofp<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span><br>          ofp<span class="token punctuation">.</span>base<span class="token punctuation">,</span><br>          ofp<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>          $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>          $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"ofp.oldOffer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>          ofp<span class="token punctuation">.</span>local<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>With the <code>prev</code>/<code>next</code> in hand, we finally store the offer in the <code>offers</code> map.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>712
713
714
715
716
717
718
719
720
721
722
723
724
725
726</pre></code>
          <pre>    <span class="token builtin">bytes32</span> ofr <span class="token operator">=</span><br>      $$<span class="token punctuation">(</span><br>        <span class="token function">make_offer</span><span class="token punctuation">(</span><br>          <span class="token punctuation">[</span><br>            <span class="token punctuation">[</span><span class="token string">"prev"</span><span class="token punctuation">,</span> <span class="token string">"prev"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token string">"next"</span><span class="token punctuation">,</span> <span class="token string">"next"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token string">"wants"</span><span class="token punctuation">,</span> <span class="token string">"ofp.wants"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token string">"gives"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gives"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>            <span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"ofp.gasprice"</span><span class="token punctuation">]</span><br>          <span class="token punctuation">]</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> ofr<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-find-position">Find Position</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>findPosition</code> takes a price in the form of a (<code>ofp.wants</code>,<code>ofp.gives</code>) pair, an offer id (<code>ofp.pivotId</code>) and walks the book from that offer (backward or forward) until the right position for the price is found. The position is returned as a <code>(prev,next)</code> pair, with <code>prev</code> or <code>next</code> at 0 to mark the beginning/end of the book (no offer ever has id 0).</p>
<p>If prices are equal, <code>findPosition</code> will put the newest offer last.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>731
732
733
734
735
736</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">findPosition</span><span class="token punctuation">(</span>OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    <span class="token keyword">view</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> pivotId <span class="token operator">=</span> ofp<span class="token punctuation">.</span>pivotId<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Get <code>pivot</code>, optimizing for the case where pivot info is already known</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>738
739
740</pre></code>
          <pre>    <span class="token builtin">bytes32</span> pivot <span class="token operator">=</span><br>      pivotId <span class="token operator">==</span> ofp<span class="token punctuation">.</span>id <span class="token operator">?</span> ofp<span class="token punctuation">.</span>oldOffer <span class="token punctuation">:</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotId<span class="token punctuation">]</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case pivotId is not an active offer, it is unusable (since it is out of the book). We default to the current best offer. If the book is empty pivot will be 0. That is handled through a test in the <code>better</code> comparison function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>742
743
744
745
746</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isLive</span><span class="token punctuation">(</span>pivot<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      pivotId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"ofp.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      pivot <span class="token operator">=</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Pivot is better than <code>wants/gives</code>, we follow <code>next</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>748
749
750
751
752
753
754
755
756
757
758
759</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">better</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> pivot<span class="token punctuation">,</span> pivotId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">bytes32</span> pivotNext<span class="token punctuation">;</span><br>      <span class="token keyword">while</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token builtin">uint</span> pivotNextId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        pivotNext <span class="token operator">=</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotNextId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">better</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> pivotNext<span class="token punctuation">,</span> pivotNextId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          pivotId <span class="token operator">=</span> pivotNextId<span class="token punctuation">;</span><br>          pivot <span class="token operator">=</span> pivotNext<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>returns from here on empty book</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>761
762</pre></code>
          <pre>      <span class="token keyword">return</span> <span class="token punctuation">(</span>pivotId<span class="token punctuation">,</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>Pivot is strictly worse than <code>wants/gives</code>, we follow <code>prev</code>.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>764
765
766
767
768
769
770
771
772
773
774
775
776
777
778
779</pre></code>
          <pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token builtin">bytes32</span> pivotPrev<span class="token punctuation">;</span><br>      <span class="token keyword">while</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token builtin">uint</span> pivotPrevId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>        pivotPrev <span class="token operator">=</span> offers<span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>ofp<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>pivotPrevId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">better</span><span class="token punctuation">(</span>ofp<span class="token punctuation">,</span> pivotPrev<span class="token punctuation">,</span> pivotPrevId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token keyword">break</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>          pivotId <span class="token operator">=</span> pivotPrevId<span class="token punctuation">;</span><br>          pivot <span class="token operator">=</span> pivotPrev<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"pivot"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pivotId<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-better">Better</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The utility method <code>better</code>
returns false iff the point induced by <em>(<code>wants1</code>,<code>gives1</code>,<code>offerDetails[offerId1].gasreq</code>)</em> is strictly worse than the point induced by <em>(<code>wants2</code>,<code>gives2</code>,<code>gasreq2</code>)</em>. It makes <code>findPosition</code> easier to read. “Worse” is defined on the lexicographic order <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>price</mtext><msub><mo>×</mo><mtext>lex</mtext></msub><msup><mtext>density</mtext><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\textrm{price} \times_{\textrm{lex}} \textrm{density}^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8623000000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">price</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin"><span class="mbin">×</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord textrm mtight">lex</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.0928879999999999em;vertical-align:-0.19444em;"></span><span class="mord"><span class="mord text"><span class="mord textrm">density</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984479999999999em;"><span style="top:-3.14734em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>.</p>
<p>This means that for the same price, offers that deliver more volume per gas are taken first.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>786
787
788
789
790
791
792
793</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">better</span><span class="token punctuation">(</span><br>    OfferPack <span class="token keyword">memory</span> ofp<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> offer1<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId1<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> wants1 <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"offer1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gives1 <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"offer1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>offerId1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>happens on empty book</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>795
796
797
798
799
800
801</pre></code>
          <pre>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token builtin">uint</span> wants2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>wants<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> gives2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>gives<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> weight1 <span class="token operator">=</span> wants1 <span class="token operator">*</span> gives2<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> weight2 <span class="token operator">=</span> wants2 <span class="token operator">*</span> gives1<span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>weight1 <span class="token operator">==</span> weight2<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>To save gas, instead of giving the <code>gasreq1</code> argument directly, we provided a path to it (with <code>offerDetails</code> and <code>offerid1</code>). If necessary (ie. if the prices <code>wants1/gives1</code> and <code>wants2/gives2</code> are the same), we read storage to get <code>gasreq2</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>803
804
805
806
807
808
809
810
811</pre></code>
          <pre>      <span class="token builtin">uint</span> gasreq1 <span class="token operator">=</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetails[ofp.base][ofp.quote][offerId1]"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token builtin">uint</span> gasreq2 <span class="token operator">=</span> ofp<span class="token punctuation">.</span>gasreq<span class="token punctuation">;</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span>gives1 <span class="token operator">*</span> gasreq2 <span class="token operator">>=</span> gives2 <span class="token operator">*</span> gasreq1<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> weight1 <span class="token operator">&lt;</span> weight2<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-low-level-taker-functions">Low-level Taker functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>MultiOrder</code> struct is used by market orders and snipes. Some of its fields are only used by market orders (<code>initialWants, initialGives</code>), and <code>successCount</code> is only used by snipes. The struct is helpful in decreasing stack use.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>815
816
817
818
819
820
821
822
823
824
825</pre></code>
          <pre>  <span class="token keyword">struct</span> <span class="token class-name">MultiOrder</span> <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> initialWants<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> initialGives<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> totalGot<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> totalGave<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> totalPenalty<span class="token punctuation">;</span><br>    <span class="token builtin">address</span> taker<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> successCount<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> failCount<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-general-market-order">General Market Order</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>General market orders set up the market order with a given <code>taker</code> (<code>msg.sender</code> in the most common case). Returns <code>(totalGot, totalGave)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>829
830
831
832
833
834
835</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">generalMarketOrder</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> taker<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since amounts stored in offers are 96 bits wide, checking that <code>takerWants</code> fits in 160 bits prevents overflow during the main market order loop.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>837
838</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint160</span><span class="token punctuation">(</span>takerWants<span class="token punctuation">)</span> <span class="token operator">==</span> takerWants<span class="token punctuation">,</span> <span class="token string">"dex/mOrder/takerWants/160bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>SingleOrder</code> is defined in <code>DexCommon.sol</code> and holds information for ordering the execution of one offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>840
841
842
843</pre></code>
          <pre>    DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">;</span><br>    sor<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span><br>    sor<span class="token punctuation">.</span>quote <span class="token operator">=</span> quote<span class="token punctuation">;</span><br>    <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Throughout the execution of the market order, the <code>sor</code>’s offer id and other parameters will change. We start with the current best offer id (0 if the book is empty).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>845
846</pre></code>
          <pre>    sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">local_best</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>sor.wants</code> and <code>sor.gives</code> may evolve, but they are initially however much remains in the market order.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>848
849
850</pre></code>
          <pre>    sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span><br>    sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>MultiOrder</code> (defined above) maintains information related to the entire market order. During the order, initial <code>wants</code>/<code>gives</code> values minus the accumulated amounts traded so far give the amounts that remain to be traded.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>852
853
854
855
856</pre></code>
          <pre>    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">;</span><br>    mor<span class="token punctuation">.</span>initialWants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span><br>    mor<span class="token punctuation">.</span>initialGives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span><br>    mor<span class="token punctuation">.</span>taker <span class="token operator">=</span> taker<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For the market order to even start, the market needs to be both active, and not currently protected from reentrancy.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>858
859
860</pre></code>
          <pre>    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Initialization</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The market order will operate as follows : it will go through offers from best to worse, starting from <code>offerId</code>, and:</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><ul>
<li>will maintain remaining <code>takerWants</code> and <code>takerGives</code> values. The initial <code>takerGives/takerWants</code> ratio is the average price the taker will accept. Better prices may be found early in the book, and worse ones later.</li>
<li>will not set <code>prev</code>/<code>next</code> pointers to their correct locations at each offer taken (this is an optimization enabled by forbidding reentrancy).</li>
<li>after consuming a segment of offers, will update the current <code>best</code> offer to be the best remaining offer on the book.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We start be enabling the reentrancy lock for this (<code>base</code>,<code>quote</code>) pair.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>868
869
870</pre></code>
          <pre>    sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalMarketOrder</code> works recursively. Going downward, each successive offer is executed until the market order stops (due to: volume exhausted, bad price, or empty book). Going upward, each offer’s <code>maker</code> contract is called again with its remaining gas and given the chance to update its offers on the book.</p>
<p>The last argument is a boolean named <code>proceed</code>. If an offer was not executed, it means the price has become too high. In that case, we notify the next recursive call that the market order should end. In this initial call, no offer has been executed yet so <code>proceed</code> is true.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>874
875</pre></code>
          <pre>    <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Over the course of the market order, a penalty reserved for <code>msg.sender</code> has accumulated in <code>mor.totalPenalty</code>. No actual transfers have occured yet – all the ethers given by the makers as provision are owned by the Dex. <code>sendPenalty</code> finally gives the accumulated penalty to <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>877</pre></code>
          <pre>    <span class="token function">sendPenalty</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>879
880
881</pre></code>
          <pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Recursive market order function</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>884
885
886
887
888</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span><br>    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span><br>    DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span><br>    <span class="token builtin">bool</span> proceed<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 1 : End of order</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We execute the offer currently stored in <code>sor</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>891
892
893
894
895</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>proceed <span class="token operator">&amp;&amp;</span> sor<span class="token punctuation">.</span>wants <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sor<span class="token punctuation">.</span>offerId <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">bool</span> success<span class="token punctuation">;</span> <span class="token comment">// execution success/failure</span><br>      <span class="token builtin">uint</span> gasused<span class="token punctuation">;</span> <span class="token comment">// gas used by `makerTrade`</span><br>      <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span> <span class="token comment">// data returned by maker</span><br>      <span class="token builtin">bytes32</span> errorCode<span class="token punctuation">;</span> <span class="token comment">// internal dex error code</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>executed</code> is false if offer could not be executed against 2nd and 3rd argument of execute. Currently, we interrupt the loop and let the taker leave with less than they asked for (but at a correct price). We could also revert instead of breaking; this could be a configurable flag for the taker to pick.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>reduce stack size for recursion</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>898
899
900</pre></code>
          <pre><br>      <span class="token builtin">bool</span> executed<span class="token punctuation">;</span> <span class="token comment">// offer execution attempted or not</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Load additional information about the offer. We don’t do it earlier to save one storage read in case <code>proceed</code> was false.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>902
903</pre></code>
          <pre>      sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>execute</code> will adjust <code>sor.wants</code>,<code>sor.gives</code>, and may attempt to execute the offer if its price is low enough. It is crucial that an error due to <code>taker</code> triggers a revert. That way, <code>!success &amp;&amp; !executed</code> means there was no execution attempt, and <code>!success &amp;&amp; executed</code> means the failure is the maker’s fault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-execution, <code>sor.wants</code>/<code>sor.gives</code> reflect how much was sent/taken by the offer. We will need it after the recursive call, so we save it in local variables. Same goes for <code>offerId</code>, <code>sor.offer</code> and <code>sor.offerDetail</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>906
907
908</pre></code>
          <pre>      <span class="token punctuation">(</span>success<span class="token punctuation">,</span> executed<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Keep cached copy of current <code>sor</code> values.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>910
911
912
913
914
915</pre></code>
          <pre>        <span class="token builtin">uint</span> takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span><br>        <span class="token builtin">uint</span> takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span><br>        <span class="token builtin">uint</span> offerId <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">;</span><br>        <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span><br>        <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If an execution was attempted, we move <code>sor</code> to the next offer. Note that the current state is inconsistent, since we have not yet updated <code>sor.offerDetails</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>917</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It is known statically that <code>mor.initialWants - mor.totalGot</code> does not underflow since</p>
<ol>
<li><code>mor.totalGot</code> was increased by <code>sor.wants</code> during <code>execute</code>,</li>
<li><code>sor.wants</code> was at most <code>mor.initialWants - mor.totalGot</code> from earlier step,</li>
<li><code>sor.wants</code> may be have been clamped <em>down</em> to <code>offer.gives</code> during <code>execute</code></li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>923</pre></code>
          <pre>          sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> mor<span class="token punctuation">.</span>initialWants <span class="token operator">-</span> mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It is known statically that <code>mor.initialGives - mor.totalGave</code> does not underflow since</p>
<ol>
<li><code>mor.totalGave</code> was increase by <code>sor.gives</code> during <code>execute</code>,</li>
<li><code>sor.gives</code> was at most <code>mor.initialGives - mor.totalGave</code> from earlier step,</li>
<li><code>sor.gives</code> may have been clamped <em>down</em> during <code>execute</code> (to <code>makerWouldWant</code>, cf. code of <code>execute</code>).</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>929
930
931
932
933</pre></code>
          <pre>          sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> mor<span class="token punctuation">.</span>initialGives <span class="token operator">-</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">;</span><br>          sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>          sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>note that internalMarketOrder may be called twice with same offerId, but in that case <code>proceed</code> will be false!</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>935
936
937</pre></code>
          <pre>        <span class="token function">internalMarketOrder</span><span class="token punctuation">(</span><br>          mor<span class="token punctuation">,</span><br>          sor<span class="token punctuation">,</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p><code>proceed</code> value for next call</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>939
940
941</pre></code>
          <pre>          executed<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Restore <code>sor</code> values from to before recursive call</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>943
944
945
946
947
948
949</pre></code>
          <pre>        sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> offerId<span class="token punctuation">;</span><br>        sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span><br>        sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span><br>        sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span><br>        sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetail<span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer execution, we may run callbacks and increase the total penalty. As that part is common to market orders and snipes, it lives in its own <code>postExecute</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>951
952
953</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">postExecute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> success<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 2 : End of market order</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If <code>proceed</code> is false, the taker has gotten its requested volume, or we have reached the end of the book, we conclude the market order.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>956</pre></code>
          <pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>During the market order, all executed offers have been removed from the book. We end by stitching together the <code>best</code> offer pointer and the new best offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>958</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Now that the market order is over, we can lift the lock on the book. In the same operation we</p>
<ul>
<li>lift the reentrancy lock, and</li>
<li>update the storage</li>
</ul>
<p>so we are free from out of order storage writes.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>966
967
968</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      locals<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>applyFee</code> extracts the fee from the taker, proportional to the amount purchased</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>970
971</pre></code>
          <pre>      <span class="token function">applyFee</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In an FTD, amounts have been lent by each offer’s maker to the taker. We now call the taker. This is a noop in an FMD.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>973
974
975
976</pre></code>
          <pre>      <span class="token function">executeEnd</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-general-snipe(s)">General Snipe(s)</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>A conduit from <code>snipe</code> and <code>snipeFor</code> to <code>generalSnipes</code>. Returns <code>(success,takerGot,takerGave)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>979
980
981
982
983
984
985
986
987
988
989
990
991
992
993
994
995
996
997
998
999
1000
1001</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">generalSnipe</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerWants<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> takerGives<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasreq<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> taker<br>  <span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">bool</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> targets <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    targets<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>offerId<span class="token punctuation">,</span> takerWants<span class="token punctuation">,</span> takerGives<span class="token punctuation">,</span> gasreq<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token punctuation">(</span><span class="token builtin">uint</span> successes<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGot<span class="token punctuation">,</span> <span class="token builtin">uint</span> takerGave<span class="token punctuation">)</span> <span class="token operator">=</span><br>      <span class="token function">generalSnipes</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> taker<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span>successes <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> takerGot<span class="token punctuation">,</span> takerGave<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>From an array of <em>n</em> <code>[offerId, takerWants,takerGives,gasreq]</code> elements, execute each snipe in sequence. Returns <code>(successes, takerGot, takerGave)</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1004
1005
1006
1007
1008
1009
1010
1011
1012
1013
1014
1015
1016
1017
1018
1019
1020
1021
1022
1023
1024</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">generalSnipes</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> targets<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> taker<br>  <span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">uint</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><span class="token punctuation">,</span><br>      <span class="token builtin">uint</span><br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">;</span><br>    sor<span class="token punctuation">.</span>base <span class="token operator">=</span> base<span class="token punctuation">;</span><br>    sor<span class="token punctuation">.</span>quote <span class="token operator">=</span> quote<span class="token punctuation">;</span><br>    <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">config</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">;</span><br>    mor<span class="token punctuation">.</span>taker <span class="token operator">=</span> taker<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>For the snipes to even start, the market needs to be both active and not currently protected from reentrancy.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1026
1027
1028</pre></code>
          <pre>    <span class="token function">activeMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>global<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">unlockedMarketOnly</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>local<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Main loop</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We start be enabling the reentrancy lock for this (<code>base</code>,<code>quote</code>) pair.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1033
1034
1035</pre></code>
          <pre>    sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>internalSnipes</code> works recursively. Going downward, each successive offer is executed until each snipe in the array has been tried. Going upward, each offer’s <code>maker</code> contract is called again with its remaining gas and given the chance to update its offers on the book.</p>
<p>The last argument is the array index for the current offer. It is initially 0.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1039
1040</pre></code>
          <pre>    <span class="token function">internalSnipes</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Over the course of the snipes order, a penalty reserved for <code>msg.sender</code> has accumulated in <code>mor.totalPenalty</code>. No actual transfers have occured yet – all the ethers given by the makers as provision are owned by the Dex. <code>sendPenalty</code> finally gives the accumulated penalty to <code>msg.sender</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1042</pre></code>
          <pre>    <span class="token function">sendPenalty</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalPenalty<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1044
1045
1046</pre></code>
          <pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>successCount<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>totalGave<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3>Recursive snipes function</h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1049
1050
1051
1052
1053
1054</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">internalSnipes</span><span class="token punctuation">(</span><br>    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span><br>    DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> targets<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> i<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 1 : continuation of snipes</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1056
1057
1058
1059
1060</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> targets<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>      sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offers<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br>      sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetails<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>offerId<span class="token punctuation">]</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If we removed the <code>isLive</code> conditional, a single expired or nonexistent offer in <code>targets</code> would revert the entire transaction (by the division by <code>offer.gives</code> below since <code>offer.gives</code> would be 0). We also check that <code>gasreq</code> is not worse than specified. A taker who does not care about <code>gasreq</code> can specify any amount larger than <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>24</mn></msup><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{24}-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>. A mismatched price will be detected by <code>execute</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1062
1063
1064
1065</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><br>        <span class="token operator">!</span><span class="token function">isLive</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>offer<span class="token punctuation">)</span> <span class="token operator">||</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><br>      <span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We move on to the next offer in the array.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1067
1068
1069
1070
1071
1072
1073
1074
1075
1076
1077
1078
1079
1080
1081</pre></code>
          <pre>        <span class="token function">internalSnipes</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>        <span class="token builtin">bool</span> success<span class="token punctuation">;</span><br>        <span class="token builtin">uint</span> gasused<span class="token punctuation">;</span><br>        <span class="token builtin">bool</span> executed<span class="token punctuation">;</span><br>        <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span><br>        <span class="token builtin">bytes32</span> errorCode<span class="token punctuation">;</span><br><br>        <span class="token keyword">require</span><span class="token punctuation">(</span><br>          <span class="token builtin">uint96</span><span class="token punctuation">(</span>targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>          <span class="token string">"dex/snipes/takerWants/96bits"</span><br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>        sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>        sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> targets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>execute</code> will adjust <code>sor.wants</code>,<code>sor.gives</code>, and may attempt to execute the offer if its price is low enough. It is crucial that an error due to <code>taker</code> triggers a revert. That way, <code>!success &amp;&amp; !executed</code> means there was no execution attempt, and <code>!success &amp;&amp; executed</code> means the failure is the maker’s fault.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-execution, <code>sor.wants</code>/<code>sor.gives</code> reflect how much was sent/taken by the offer. We will need it after the recursive call, so we save it in local variables. Same goes for <code>offerId</code>, <code>sor.offer</code> and <code>sor.offerDetail</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1084
1085</pre></code>
          <pre>        <span class="token punctuation">(</span>success<span class="token punctuation">,</span> executed<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">execute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In the market order, we were able to avoid stitching back offers after every <code>execute</code> since we knew a continuous segment starting at best would be consumed. Here, we cannot do this optimisation since offers in the <code>targets</code> array may be anywhere in the book. So we stitch together offers immediately after each <code>execute</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1087
1088
1089
1090
1091
1092
1093
1094
1095
1096
1097</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          sor<span class="token punctuation">.</span>local <span class="token operator">=</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span><br>            sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span><br>            sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>            $$<span class="token punctuation">(</span><span class="token function">offer_prev</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            $$<span class="token punctuation">(</span><span class="token function">offer_next</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>            sor<span class="token punctuation">.</span>local<br>          <span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br><br>        <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Keep cached copy of current <code>sor</code> values.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1099
1100
1101
1102
1103
1104</pre></code>
          <pre>          <span class="token builtin">uint</span> offerId <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">;</span><br>          <span class="token builtin">uint</span> takerWants <span class="token operator">=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span><br>          <span class="token builtin">uint</span> takerGives <span class="token operator">=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span><br>          <span class="token builtin">bytes32</span> offer <span class="token operator">=</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">;</span><br>          <span class="token builtin">bytes32</span> offerDetail <span class="token operator">=</span> sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We move on to the next offer in the array.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1106
1107</pre></code>
          <pre>          <span class="token function">internalSnipes</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> targets<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Restore <code>sor</code> values from to before recursive call</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1109
1110
1111
1112
1113
1114
1115</pre></code>
          <pre>          sor<span class="token punctuation">.</span>offerId <span class="token operator">=</span> offerId<span class="token punctuation">;</span><br>          sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> takerWants<span class="token punctuation">;</span><br>          sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> takerGives<span class="token punctuation">;</span><br>          sor<span class="token punctuation">.</span>offer <span class="token operator">=</span> offer<span class="token punctuation">;</span><br>          sor<span class="token punctuation">.</span>offerDetail <span class="token operator">=</span> offerDetail<span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After an offer execution, we may run callbacks and increase the total penalty. As that part is common to market orders and snipes, it lives in its own <code>postExecute</code> function.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1117
1118
1119
1120</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token function">postExecute</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> success<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span><br>      <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4>Case 2 : End of snipes</h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1122</pre></code>
          <pre>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Now that the snipes is over, we can lift the lock on the book. In the same operation we</p>
<ul>
<li>lift the reentrancy lock, and</li>
<li>update the storage</li>
</ul>
<p>so we are free from out of order storage writes.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1129
1130</pre></code>
          <pre>      sor<span class="token punctuation">.</span>local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"lock"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      locals<span class="token punctuation">[</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>sor<span class="token punctuation">.</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> sor<span class="token punctuation">.</span>local<span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>applyFee</code> extracts the fee from the taker, proportional to the amount purchased</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1132</pre></code>
          <pre>      <span class="token function">applyFee</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In an FTD, amounts have been lent by each offer’s maker to the taker. We now call the taker. This is a noop in an FMD.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1134
1135
1136
1137</pre></code>
          <pre>      <span class="token function">executeEnd</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-execute">Execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This function will compare <code>sor.wants</code> <code>sor.gives</code> with <code>sor.offer.wants</code> and <code>sor.offer.gives</code>. If the price of the offer is low enough, an execution will be attempted (with volume limited by the offer’s advertised volume).</p>
<p>Summary of the meaning of the return values:</p>
<ul>
<li><code>gasused</code> is the gas consumed by the execution</li>
<li><code>makerData</code> is the data returned after executing the offer</li>
<li><code>errorCode</code> is the internal dex error code</li>
<li><code>success -&gt; executed</code></li>
<li><code>success &amp;&amp; executed</code>: offer has succeeded</li>
<li><code>!success &amp;&amp; executed</code>: offer has failed</li>
<li><code>!success &amp;&amp; !executed</code>: offer has not been executed</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1149
1150
1151
1152
1153
1154
1155
1156
1157
1158</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">execute</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">bool</span> success<span class="token punctuation">,</span><br>      <span class="token builtin">bool</span> executed<span class="token punctuation">,</span><br>      <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span><br>      <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span><br>      <span class="token builtin">bytes32</span> errorCode<br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h4><code>makerWouldWant</code></h4>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The current offer has a price <code><em>p</em> = sor.offer.wants/sor.offer.gives</code>. <code>makerWouldWant</code> is the amount of <code>quote</code> the offer would require at price <em>p</em> to provide <code>sor.wants</code> <code>base</code>. Computing <code>makeWouldWant</code> gives us both a test that <em>p</em> is an acceptable price for the taker, and the amount of <code>quote</code> to send to the maker.</p>
<p><strong>Note</strong>: We never check that <code>offerId</code> is actually a <code>uint24</code>, or that <code>offerId</code> actually points to an offer: it is not possible to insert an offer with an id larger than that, and a wrong <code>offerId</code> will point to a zero-initialized offer, which will revert the call when dividing by <code>offer.gives</code>.</p>
<p>Prices are rounded down.</p>
<p><strong>Historical note</strong>: prices used to be rounded up (<code>makerWouldWant = product/offer.gives + (product % offer.gives == 0 ? 0 : 1)</code>) because partially filled offers used to remain on the book. A snipe which names an offer by its id also specifies its price in the form of a <code>(wants,gives)</code> pair to be compared to the offers’ <code>(wants,gives)</code>. When a snipe can specifies a wants and a gives, it accepts any offer price better than <code>wants/gives</code>.</p>
<p>Now consider an order <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> for the offer <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">o</span></span></span></span>. If <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">o</span></span></span></span> is partially consumed into <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>o</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">o&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> before <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> is mined, we still want <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> to succeed (as long as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>o</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">o&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> has enough volume). But <code>wants</code> and <code>gives</code> of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi></mrow><annotation encoding="application/x-tex">o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.43056em;vertical-align:0em;"></span><span class="mord mathnormal">o</span></span></span></span> are not equal to <code>wants</code> and <code>gives</code> of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>o</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">o&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>. Worse: their ratios are not equal, due to rounding errors.</p>
<p>Our solution was to make sure that the price of a partially filled offer could only improve. To do that, we rounded up the amount required by the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1173
1174
1175</pre></code>
          <pre>    <span class="token builtin">uint</span> makerWouldWant <span class="token operator">=</span><br>      <span class="token punctuation">(</span>sor<span class="token punctuation">.</span>wants <span class="token operator">*</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the price is too high, we return early. Otherwise we now know we’ll execute the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1177
1178
1179
1180
1181
1182</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>makerWouldWant <span class="token operator">></span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    executed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If the current offer is good enough for the taker can accept, we compute how much the taker should give/get on the <em>current offer</em>. So we adjust <code>sor.wants</code> and <code>sor.gives</code> as follow: if the offer cannot fully satisfy the taker (<code>sor.offer.gives &lt; sor.wants</code>), we consume the entire offer. Otherwise <code>sor.wants</code> doesn’t need to change (the taker will receive everything they wants), and <code>sor.gives</code> is adjusted downward to meet the offer’s price.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1184
1185
1186
1187
1188
1189
1190</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      sor<span class="token punctuation">.</span>wants <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_gives</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_wants</span><span class="token punctuation">(</span><span class="token string">"sor.offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      sor<span class="token punctuation">.</span>gives <span class="token operator">=</span> makerWouldWant<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The flashloan is executed by call to <code>FLASHLOANER</code>. If the call reverts, it means the maker failed to send back <code>sor.wants</code> <code>base</code> to the taker. Notes :</p>
<ul>
<li><code>msg.sender</code> is the Dex itself in those calls – all operations related to the actual caller should be done outside of this call.</li>
<li>any spurious exception due to an error in Dex code will be falsely blamed on the Maker, and its provision for the offer will be unfairly taken away.</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1195
1196
1197
1198
1199</pre></code>
          <pre>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> retdata<span class="token punctuation">;</span><br>    <span class="token punctuation">(</span>success<span class="token punctuation">,</span> retdata<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><br>      abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>FLASHLOANER<span class="token punctuation">,</span> sor<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>success</code> is true: trade is complete</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1201
1202</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      mor<span class="token punctuation">.</span>successCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case of success, <code>retdata</code> encodes the gas used by the offer.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1204
1205
1206
1207
1208
1209
1210
1211
1212
1213
1214</pre></code>
          <pre>      gasused <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>      <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span><br>        sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span><br>        mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>wants<span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>gives<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If configured to do so, the Dex notifies an external contract that a successful trade has taken place.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1216
1217
1218
1219
1220
1221
1222</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_notify</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token function">IDexMonitor</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifySuccess</span><span class="token punctuation">(</span><br>          sor<span class="token punctuation">,</span><br>          mor<span class="token punctuation">.</span>taker<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We update the totals in the multiorder based on the adjusted <code>sor.wants</code>/<code>sor.gives</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1224
1225
1226</pre></code>
          <pre>      mor<span class="token punctuation">.</span>totalGot <span class="token operator">+=</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">;</span><br>      mor<span class="token punctuation">.</span>totalGave <span class="token operator">+=</span> sor<span class="token punctuation">.</span>gives<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>In case of failure, <code>retdata</code> encodes a short error code, the gas used by the offer, and an arbitrary 256 bits word sent by the maker. <code>errorCode</code> should not be exploitable by the maker!</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1228</pre></code>
          <pre>      <span class="token punctuation">(</span>errorCode<span class="token punctuation">,</span> gasused<span class="token punctuation">,</span> makerData<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">innerDecode</span><span class="token punctuation">(</span>retdata<span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Note that in the <code>if</code>s, the literals are bytes32 (stack values), while as revert arguments, they are strings (memory pointers).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1230
1231
1232
1233
1234
1235
1236
1237
1238
1239
1240
1241
1242
1243
1244
1245</pre></code>
          <pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span><br>        errorCode <span class="token operator">==</span> <span class="token string">"dex/makerRevert"</span> <span class="token operator">||</span> errorCode <span class="token operator">==</span> <span class="token string">"dex/makerTransferFail"</span><br>      <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        mor<span class="token punctuation">.</span>failCount <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span><br><br>        <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">MakerFail</span><span class="token punctuation">(</span><br>          sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span><br>          sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>          sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span><br>          mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span><br>          sor<span class="token punctuation">.</span>wants<span class="token punctuation">,</span><br>          sor<span class="token punctuation">.</span>gives<span class="token punctuation">,</span><br>          errorCode<span class="token punctuation">,</span><br>          makerData<br>        <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>If configured to do so, the Dex notifies an external contract that a failed trade has taken place.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1247
1248
1249
1250
1251
1252</pre></code>
          <pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_notify</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>          <span class="token function">IDexMonitor</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notifyFail</span><span class="token punctuation">(</span><br>            sor<span class="token punctuation">,</span><br>            mor<span class="token punctuation">.</span>taker<br>          <span class="token punctuation">)</span><span class="token punctuation">;</span><br>        <span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>It is crucial that any error code which indicates an error caused by the taker triggers a revert, because functions that call <code>execute</code> consider that <code>execute &amp;&amp; !success</code> should be blamed on the maker.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1254
1255
1256
1257
1258</pre></code>
          <pre>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> <span class="token string">"dex/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"dex/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>errorCode <span class="token operator">==</span> <span class="token string">"dex/takerFailToPayMaker"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"dex/takerFailToPayMaker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>This code must be unreachable. <strong>Danger</strong>: if a well-crafted offer/maker pair can force a revert of FLASHLOANER, the Dex will be stuck.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1260
1261
1262
1263</pre></code>
          <pre>        <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"dex/swapError"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token punctuation">}</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Delete the offer. The last argument indicates whether the offer should be stripped of its provision (yes if execution failed, no otherwise). We delete offers whether the amount remaining on offer is &gt; density or not for the sake of uniformity (code is much simpler). We also expect prices to move often enough that the maker will want to update their price anyway. To simulate leaving the remaining volume in the offer, the maker can program their <code>makerPosthook</code> to <code>updateOffer</code> and put the remaining volume back in.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1265
1266
1267
1268
1269</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>executed<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offerId<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>offer<span class="token punctuation">,</span> <span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-post-execute">Post execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>After executing an offer (whether in a market order or in snipes), we</p>
<ol>
<li>FTD only, if execution successful: transfer the correct amount back to the maker.</li>
<li>If offer was executed: call the maker’s posthook and sum the total gas used. In FTD, the posthook is called with the amount already in the maker’s hands.</li>
<li>If offer failed: sum total penalty due to taker and give remainder to maker.</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1276
1277
1278
1279
1280
1281
1282
1283
1284
1285
1286
1287
1288
1289</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">postExecute</span><span class="token punctuation">(</span><br>    MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span><br>    DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span><br>    <span class="token builtin">bool</span> success<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> errorCode<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">executeCallback</span><span class="token punctuation">(</span>mor<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We are about to call back the maker, giving it its unused gas (<code>gasreq - gasused</code>). Since the gas used so far may exceed <code>gasreq</code>, we prevent underflow in the subtraction below by bounding <code>gasused</code> above with <code>gasreq</code>. We could have decided not to call back the maker at all when there is no gas left, but we do it for uniformity.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1291
1292
1293
1294
1295
1296
1297
1298</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gasused <span class="token operator">></span> gasreq<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      gasused <span class="token operator">=</span> gasreq<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    gasused <span class="token operator">=</span><br>      gasused <span class="token operator">+</span><br>      <span class="token function">makerPosthook</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> gasreq <span class="token operator">-</span> gasused<span class="token punctuation">,</span> success<span class="token punctuation">,</span> makerData<span class="token punctuation">,</span> errorCode<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Once again, the gas used may exceed <code>gasreq</code>. Since penalties extracted depend on <code>gasused</code> and the maker has at most provisioned for <code>gasreq</code> being used, we prevent fund leaks by bounding <code>gasused</code> once more.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1300
1301
1302
1303
1304
1305
1306
1307
1308
1309
1310
1311
1312
1313
1314</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>gasused <span class="token operator">></span> gasreq<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      gasused <span class="token operator">=</span> gasreq<span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      mor<span class="token punctuation">.</span>totalPenalty <span class="token operator">+=</span> <span class="token function">applyPenalty</span><span class="token punctuation">(</span><br>        $$<span class="token punctuation">(</span><span class="token function">global_gasprice</span><span class="token punctuation">(</span><span class="token string">"sor.global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        gasused<span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>offer<span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>offerDetail<span class="token punctuation">,</span><br>        mor<span class="token punctuation">.</span>failCount<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-maker-posthook">Maker Posthook</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1316
1317
1318
1319
1320
1321
1322</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">makerPosthook</span><span class="token punctuation">(</span><br>    DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasLeft<span class="token punctuation">,</span><br>    <span class="token builtin">bool</span> success<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> errorCode<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span> <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>At this point, errorCode can only be “dex/makerRevert” or “dex/makerTransferFail”</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1324
1325
1326
1327
1328
1329
1330
1331
1332
1333
1334</pre></code>
          <pre>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span><br>      abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span><br>        IMaker<span class="token punctuation">.</span>makerPosthook<span class="token punctuation">.</span>selector<span class="token punctuation">,</span><br>        sor<span class="token punctuation">,</span><br>        DC<span class="token punctuation">.</span><span class="token function">OrderResult</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>          success<span class="token punctuation">:</span> success<span class="token punctuation">,</span><br>          makerData<span class="token punctuation">:</span> makerData<span class="token punctuation">,</span><br>          errorCode<span class="token punctuation">:</span> errorCode<br>        <span class="token punctuation">}</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Calls an external function with controlled gas expense. A direct call of the form <code>(,bytes memory retdata) = maker.call{gas}(selector,...args)</code> enables a griefing attack: the maker uses half its gas to write in its memory, then reverts with that memory segment as argument. After a low-level call, solidity automaticaly copies <code>returndatasize</code> bytes of <code>returndata</code> into memory. So the total gas consumed to execute a failing offer could exceed <code>gasreq</code>. This yul call only retrieves the first byte of the maker’s <code>returndata</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1336
1337
1338
1339
1340</pre></code>
          <pre>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> retdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token builtin">address</span> maker <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token builtin">uint</span> oldGas <span class="token operator">=</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We let the maker pay for the overhead of checking remaining gas and making the call. So the <code>require</code> below is just an approximation: if the overhead of (<code>require</code> + cost of <code>CALL</code>) is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the maker will receive at worst <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gasreq</mtext><mo>−</mo><mfrac><mrow><mn>63</mn><mi>h</mi></mrow><mn>64</mn></mfrac></mrow><annotation encoding="application/x-tex">\textrm{gasreq} - \frac{63h}{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gasreq</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1342
1343
1344
1345
1346
1347
1348
1349
1350
1351
1352
1353
1354
1355
1356
1357
1358
1359</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldGas <span class="token operator">-</span> oldGas <span class="token operator">/</span> <span class="token number">64</span> <span class="token operator">>=</span> gasLeft<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token keyword">revert</span><span class="token punctuation">(</span><span class="token string">"dex/notEnoughGasForMakerPosthook"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">assembly</span> <span class="token punctuation">{</span><br>      <span class="token keyword">let</span> success2 <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><br>        gasLeft<span class="token punctuation">,</span><br>        maker<span class="token punctuation">,</span><br>        <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token function">add</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">mload</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">add</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token number">32</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    gasused <span class="token operator">=</span> oldGas <span class="token operator">-</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-low-level-offer-deletion">Low-level offer deletion</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>When an offer is deleted, it is marked as such by setting <code>gives</code> to 0. Note that provision accounting in the Dex aims to minimize writes. Each maker <code>fund</code>s the Dex to increase its balance. When an offer is created/updated, we compute how much should be reserved to pay for possible penalties. That amount can always be recomputed with <code>offer.gasprice * (offerDetail.gasreq + offerDetail.overhead_gasbase + offerDetail.offer_gasbase)</code>. The balance is updated to reflect the remaining available ethers.</p>
<p>Now, when an offer is deleted, the offer can stay provisioned, or be <code>deprovision</code>ed. In the latter case, we set <code>gasprice</code> to 0, which induces a provision of 0.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1365
1366
1367
1368
1369
1370
1371
1372
1373
1374
1375
1376
1377
1378</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">dirtyDeleteOffer</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offerId<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> offer<span class="token punctuation">,</span><br>    <span class="token builtin">bool</span> deprovision<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    offer <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gives"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>deprovision<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      offer <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>offerId<span class="token punctuation">]</span> <span class="token operator">=</span> offer<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Post-trade, <code>applyFee</code> reaches back into the taker’s pocket and extract a fee on the total amount of <code>sor.base</code> transferred to them.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1380
1381
1382
1383
1384
1385
1386
1387
1388</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">applyFee</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> $$<span class="token punctuation">(</span><span class="token function">local_fee</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">uint</span> concreteFee <span class="token operator">=</span> <span class="token punctuation">(</span>mor<span class="token punctuation">.</span>totalGot <span class="token operator">*</span> $$<span class="token punctuation">(</span><span class="token function">local_fee</span><span class="token punctuation">(</span><span class="token string">"sor.local"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">10</span>_000<span class="token punctuation">;</span><br>      mor<span class="token punctuation">.</span>totalGot <span class="token operator">-=</span> concreteFee<span class="token punctuation">;</span><br>      <span class="token builtin">bool</span> success <span class="token operator">=</span> <span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span> mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span> vault<span class="token punctuation">,</span> concreteFee<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"dex/takerFailToPayDex"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-penalties">Penalties</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Offers are just promises. They can fail. Penalty provisioning discourages from failing too much: we ask makers to provision more ETH than the expected gas cost of executing their offer and penalize them accoridng to wasted gas.</p>
<p>Under normal circumstances, we should expect to see bots with a profit expectation dry-running offers locally and executing <code>snipe</code> on failing offers, collecting the penalty. The result should be a mostly clean book for actual takers (i.e. a book with only successful offers).</p>
<p><strong>Incentive issue</strong>: if the gas price increases enough after an offer has been created, there may not be an immediately profitable way to remove the fake offers. In that case, we count on 3 factors to keep the book clean:</p>
<ol>
<li>Gas price eventually comes down.</li>
<li>Other market makers want to keep the Dex attractive and maintain their offer flow.</li>
<li>Dex governance (who may collect a fee) wants to keep the Dex attractive and maximize exchange volume.</li>
</ol>
<p>//+clear+
/* After an offer failed, part of its provision is given back to the maker and the rest is stored to be sent to the taker after the entire order completes. In <code>applyPenalty</code>, we <em>only</em> credit the maker with its excess provision. So it looks like the maker is gaining something. In fact they’re just getting back a fraction of what they provisioned earlier.
/*
Penalty application summary:</p>
<ul>
<li>If the transaction was a success, we entirely refund the maker and send nothing to the taker.</li>
<li>Otherwise, the maker loses the cost of <code>gasused + overhead_gasbase/n + offer_gasbase</code> gas, where <code>n</code> is the number of failed offers. The gas price is estimated by <code>gasprice</code>.</li>
<li>To create the offer, the maker had to provision for <code>gasreq + overhead_gasbase/n + offer_gasbase</code> gas at a price of <code>offer.gasprice</code>.</li>
<li>We do not consider the tx.gasprice.</li>
<li><code>offerDetail.gasbase</code> and <code>offer.gasprice</code> are the values of the Dex parameters <code>config.*_gasbase</code> and <code>config.gasprice</code> when the offer was created. Without caching those values, the provision set aside could end up insufficient to reimburse the maker (or to retribute the taker).</li>
</ul>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1410
1411
1412
1413
1414
1415
1416
1417
1418
1419
1420
1421
1422
1423</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">applyPenalty</span><span class="token punctuation">(</span><br>    <span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> offer<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> offerDetail<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> failCount<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> provision <span class="token operator">=</span><br>      <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span><br>        $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span><br>        <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>          $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span><br>          $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We take as gasprice min(offer.gasprice,config.gasprice)</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1425
1426
1427
1428</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> gasprice<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      gasprice <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offer_gasprice</span><span class="token punctuation">(</span><span class="token string">"offer"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We set <code>gasused = min(gasused,gasreq)</code> since <code>gasreq &lt; gasused</code> is possible e.g. with <code>gasreq = 0</code> (all calls consume nonzero gas).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1430
1431
1432
1433</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> gasused<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      gasused <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>As an invariant, <code>applyPenalty</code> is only called when <code>executed &amp;&amp; !success</code>, and thus when <code>failCount &gt; 0</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1435
1436
1437
1438
1439
1440
1441
1442</pre></code>
          <pre>    <span class="token builtin">uint</span> penalty <span class="token operator">=</span><br>      <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span> <span class="token operator">*</span><br>        gasprice <span class="token operator">*</span><br>        <span class="token punctuation">(</span>gasused <span class="token operator">+</span><br>          $$<span class="token punctuation">(</span><span class="token function">offerDetail_overhead_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span><br>          failCount <span class="token operator">+</span><br>          $$<span class="token punctuation">(</span><span class="token function">offerDetail_offer_gasbase</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Here we write to storage the new maker balance. This occurs <em>after</em> possible reentrant calls. How do we know we’re not crediting twice the same amounts? Because the <code>offer</code>’s provision was set to 0 in storage (through <code>dirtyDeleteOffer</code>) before the reentrant calls. In this function, we are working with cached copies of the offer as it was before it was consumed.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1444
1445
1446
1447
1448
1449
1450
1451
1452
1453
1454
1455</pre></code>
          <pre>    <span class="token function">creditWei</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> provision <span class="token operator">-</span> penalty<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">return</span> penalty<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">sendPenalty</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token builtin">bool</span> noRevert<span class="token punctuation">;</span><br>      <span class="token punctuation">(</span>noRevert<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">.</span>call<span class="token punctuation">{</span>gas<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> amount<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-get%2Fset-configuration-and-dex-state">Get/set configuration and Dex state</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1457
1458
1459
1460
1461
1462
1463
1464
1465
1466
1467
1468
1469
1470
1471</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">config</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">)</span><br>    <span class="token keyword">public</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span> _global<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> _local<span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    _global <span class="token operator">=</span> global<span class="token punctuation">;</span><br>    _local <span class="token operator">=</span> locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_useOracle</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> density<span class="token punctuation">)</span> <span class="token operator">=</span><br>        <span class="token function">IDexMonitor</span><span class="token punctuation">(</span>$$<span class="token punctuation">(</span><span class="token function">global_monitor</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">)</span><span class="token punctuation">;</span><br>      _global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"_global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"gasprice"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>      _local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"_local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"density"</span><span class="token punctuation">,</span> <span class="token string">"density"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-locals">Locals</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>active</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1474
1475
1476
1477
1478
1479
1480
1481
1482
1483
1484
1485
1486
1487
1488
1489
1490
1491
1492
1493
1494
1495</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> fee<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> density<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offer_gasbase<br>  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[base][quote]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"active"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setFee</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> fee<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setDensity</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> density<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token function">setGasbase</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> overhead_gasbase<span class="token punctuation">,</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetActive</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">deactivate</span><span class="token punctuation">(</span><span class="token builtin">address</span> base<span class="token punctuation">,</span> <span class="token builtin">address</span> quote<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[base][quote]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"active"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetActive</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>fee</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1497
1498
1499
1500
1501
1502</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setFee</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> value<br>  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>fee</code> is in basis points, i.e. in percents of a percent.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1504
1505
1506
1507
1508
1509
1510</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>value <span class="token operator">&lt;=</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token string">"dex/config/fee/&lt;=500"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// at most 5%</span><br>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>      <span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[base][quote]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"fee"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetFee</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>density</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Useless if <code>global.useOracle != 0</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1513
1514
1515
1516
1517
1518</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setDensity</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> value<br>  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>density</code> is necessary to prevent overflow when <code>density</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1520</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint32</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> value<span class="token punctuation">,</span> <span class="token string">"dex/config/density/32bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1522
1523
1524
1525
1526
1527</pre></code>
          <pre>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>      <span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"locals[base][quote]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"density"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetDensity</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasbase</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1529
1530
1531
1532
1533
1534
1535</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasbase</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> overhead_gasbase<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> offer_gasbase<br>  <span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>*_gasbase</code> is necessary to prevent a) data loss when <code>*_gasbase</code> is copied to an <code>OfferDetail</code> struct, and b) overflow when <code>*_gasbase</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1537
1538
1539
1540
1541
1542
1543
1544</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      <span class="token builtin">uint24</span><span class="token punctuation">(</span>overhead_gasbase<span class="token punctuation">)</span> <span class="token operator">==</span> overhead_gasbase<span class="token punctuation">,</span><br>      <span class="token string">"dex/config/overhead_gasbase/24bits"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      <span class="token builtin">uint24</span><span class="token punctuation">(</span>offer_gasbase<span class="token punctuation">)</span> <span class="token operator">==</span> offer_gasbase<span class="token punctuation">,</span><br>      <span class="token string">"dex/config/offer_gasbase/24bits"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1546
1547
1548
1549
1550
1551
1552
1553
1554
1555
1556
1557</pre></code>
          <pre>    locals<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>      <span class="token function">set_local</span><span class="token punctuation">(</span><br>        <span class="token string">"locals[base][quote]"</span><span class="token punctuation">,</span><br>        <span class="token punctuation">[</span><br>          <span class="token punctuation">[</span><span class="token string">"offer_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"offer_gasbase"</span><span class="token punctuation">]</span><span class="token punctuation">,</span><br>          <span class="token punctuation">[</span><span class="token string">"overhead_gasbase"</span><span class="token punctuation">,</span> <span class="token string">"overhead_gasbase"</span><span class="token punctuation">]</span><br>        <span class="token punctuation">]</span><br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetGasbase</span><span class="token punctuation">(</span>overhead_gasbase<span class="token punctuation">,</span> offer_gasbase<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-globals">Globals</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>kill</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1560
1561
1562
1563
1564
1565</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"dead"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">Kill</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasprice</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Useless if <code>global.useOracle is != 0</code></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1568
1569</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasprice</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Checking the size of <code>gasprice</code> is necessary to prevent a) data loss when <code>gasprice</code> is copied to an <code>OfferDetail</code> struct, and b) overflow when <code>gasprice</code> is used in calculations.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1571</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint16</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> value<span class="token punctuation">,</span> <span class="token string">"dex/config/gasprice/16bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1573
1574
1575
1576
1577</pre></code>
          <pre><br>    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasprice"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetGasprice</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h3><code>gasmax</code></h3>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1579
1580</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">setGasmax</span><span class="token punctuation">(</span><span class="token builtin">uint</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Since any new <code>gasreq</code> is bounded above by <code>config.gasmax</code>, this check implies that all offers’ <code>gasreq</code> is 24 bits wide at most.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1582</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token builtin">uint24</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">==</span> value<span class="token punctuation">,</span> <span class="token string">"dex/config/gasmax/24bits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1584
1585
1586
1587
1588
1589
1590
1591
1592
1593
1594
1595
1596
1597
1598
1599
1600
1601
1602
1603
1604
1605
1606
1607
1608
1609
1610
1611
1612
1613
1614
1615
1616
1617
1618
1619
1620
1621
1622
1623
1624
1625
1626
1627
1628
1629
1630
1631
1632</pre></code>
          <pre>    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"gasmax"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetGasmax</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">setGovernance</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    governance <span class="token operator">=</span> value<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetGovernance</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">setVault</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    vault <span class="token operator">=</span> value<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetVault</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">setMonitor</span><span class="token punctuation">(</span><span class="token builtin">address</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"monitor"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetMonitor</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token punctuation">{</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> governance <span class="token operator">||</span> msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>      <span class="token string">"dex/unauthorized"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">setUseOracle</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"useOracle"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"useOracle"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetUseOracle</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">setNotify</span><span class="token punctuation">(</span><span class="token builtin">bool</span> value<span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">{</span><br>    <span class="token function">authOnly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"notify"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      global <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_global</span><span class="token punctuation">(</span><span class="token string">"global"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"notify"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">SetNotify</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-maker-debit%2Fcredit-utility-functions">Maker debit/credit utility functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1634
1635
1636
1637
1638
1639
1640
1641
1642
1643
1644
1645
1646</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">debitWei</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> makerBalance <span class="token operator">=</span> balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>makerBalance <span class="token operator">>=</span> amount<span class="token punctuation">,</span> <span class="token string">"dex/insufficientProvision"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span> <span class="token operator">=</span> makerBalance <span class="token operator">-</span> amount<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">Debit</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">creditWei</span><span class="token punctuation">(</span><span class="token builtin">address</span> maker<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    balanceOf<span class="token punctuation">[</span>maker<span class="token punctuation">]</span> <span class="token operator">+=</span> amount<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">Credit</span><span class="token punctuation">(</span>maker<span class="token punctuation">,</span> amount<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-delegation-public-functions">Delegation public functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Adapted from <a href="https://github.com/Uniswap/uniswap-v2-core/blob/55ae25109b7918565867e5c39f1e84b7edd19b2a/contracts/UniswapV2ERC20.sol#L81">Uniswap v2 contract</a></p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1650
1651
1652
1653
1654
1655
1656
1657
1658
1659
1660
1661
1662
1663
1664
1665
1666
1667
1668
1669
1670
1671
1672
1673
1674
1675
1676
1677
1678
1679
1680
1681
1682
1683
1684
1685
1686
1687
1688
1689
1690
1691
1692
1693
1694
1695
1696
1697
1698
1699
1700
1701
1702
1703</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">permit</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> owner<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> spender<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> value<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> deadline<span class="token punctuation">,</span><br>    <span class="token builtin">uint8</span> v<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> s<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">{</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>deadline <span class="token operator">>=</span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> <span class="token string">"dex/permit/expired"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token builtin">uint</span> nonce <span class="token operator">=</span> nonces<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> digest <span class="token operator">=</span><br>      <span class="token function">keccak256</span><span class="token punctuation">(</span><br>        abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span><br>          <span class="token string">"\x19\x01"</span><span class="token punctuation">,</span><br>          DOMAIN_SEPARATOR<span class="token punctuation">,</span><br>          <span class="token function">keccak256</span><span class="token punctuation">(</span><br>            abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><br>              PERMIT_TYPEHASH<span class="token punctuation">,</span><br>              base<span class="token punctuation">,</span><br>              quote<span class="token punctuation">,</span><br>              owner<span class="token punctuation">,</span><br>              spender<span class="token punctuation">,</span><br>              value<span class="token punctuation">,</span><br>              nonce<span class="token punctuation">,</span><br>              deadline<br>            <span class="token punctuation">)</span><br>          <span class="token punctuation">)</span><br>        <span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">address</span> recoveredAddress <span class="token operator">=</span> <span class="token function">ecrecover</span><span class="token punctuation">(</span>digest<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span><br>      recoveredAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> recoveredAddress <span class="token operator">==</span> owner<span class="token punctuation">,</span><br>      <span class="token string">"dex/permit/invalidSignature"</span><br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    allowances<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">Approval</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">approve</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> spender<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> value<br>  <span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    allowances<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">[</span>spender<span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">;</span><br>    <span class="token keyword">emit</span> DexEvents<span class="token punctuation">.</span><span class="token function">Approval</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> quote<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-misc.-low-level-functions">Misc. low-level functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Connect the predecessor and sucessor of <code>id</code> through their <code>next</code>/<code>prev</code> pointers. For more on the book structure, see <code>DexCommon.sol</code>. This step is not necessary during a market order, so we only call <code>dirtyDeleteOffer</code>.</p>
<p><strong>Warning</strong>: calling with <code>pastId = 0</code> will set <code>futureId</code> as the best. So with <code>pastId = 0</code> and <code>futureId = 0</code>, it sets the book to empty and loses track of existing offers.</p>
<p><strong>Warning</strong>: may make memory copy of <code>local.best</code> stale. Returns new <code>local</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1711
1712
1713
1714
1715
1716
1717
1718
1719
1720
1721
1722
1723
1724
1725
1726
1727
1728
1729
1730
1731
1732
1733
1734</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">stitchOffers</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> pastId<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> futureId<span class="token punctuation">,</span><br>    <span class="token builtin">bytes32</span> local<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pastId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>pastId<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>        <span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offers[base][quote][pastId]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"next"</span><span class="token punctuation">,</span> <span class="token string">"futureId"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      local <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">set_local</span><span class="token punctuation">(</span><span class="token string">"local"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"best"</span><span class="token punctuation">,</span> <span class="token string">"futureId"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span>futureId <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      offers<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>futureId<span class="token punctuation">]</span> <span class="token operator">=</span> $$<span class="token punctuation">(</span><br>        <span class="token function">set_offer</span><span class="token punctuation">(</span><span class="token string">"offers[base][quote][futureId]"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">"prev"</span><span class="token punctuation">,</span> <span class="token string">"pastId"</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">return</span> local<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Used by <code>*For</code> functions, its both checks that <code>msg.sender</code> was allowed to use the taker’s funds, and decreases the former’s allowance.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1736
1737
1738
1739
1740
1741
1742
1743
1744
1745
1746</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">deductSenderAllowance</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> base<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> quote<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> owner<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> amount<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token punctuation">{</span><br>    <span class="token builtin">uint</span> allowed <span class="token operator">=</span> allowances<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>allowed <span class="token operator">></span> amount<span class="token punctuation">,</span> <span class="token string">"dex/lowAllowance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    allowances<span class="token punctuation">[</span>base<span class="token punctuation">]</span><span class="token punctuation">[</span>quote<span class="token punctuation">]</span><span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token punctuation">[</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">]</span> <span class="token operator">=</span> allowed <span class="token operator">-</span> amount<span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-flashloans">Flashloans</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-flashloan">Flashloan</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>flashloan</code> is for the ‘normal’ mode of operation. It:</p>
<ol>
<li>Flashloans <code>takerGives</code> <code>quote</code> from the taker to the maker and returns false if the loan fails.</li>
<li>Runs <code>offerDetail.maker</code>’s <code>execute</code> function.</li>
<li>Returns the result of the operations, with optional makerData to help the maker debug.</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1756
1757
1758
1759</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">flashloan</span><span class="token punctuation">(</span>DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span><br>  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>flashloan</code> must be used with a call (hence the <code>external</code> modifier) so its effect can be reverted. But a call from the outside would be fatal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1761</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dex/flashloan/protected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>the transfer from taker to maker must be in this function
so that any issue with the maker also reverts the flashloan</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1764
1765
1766
1767
1768
1769
1770
1771
1772
1773
1774
1775
1776
1777</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><br>      <span class="token function">transferToken</span><span class="token punctuation">(</span><br>        sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>        taker<span class="token punctuation">,</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>gives<br>      <span class="token punctuation">)</span><br>    <span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      gasused <span class="token operator">=</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> taker<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"dex/takerFailToPayMaker"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-inverted-flashloan">Inverted Flashloan</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>invertedFlashloan</code> is for the ‘arbitrage’ mode of operation. It:
0. Calls the maker’s <code>execute</code> function. If successful (tokens have been sent to taker):
2. Runs <code>taker</code>’s <code>execute</code> function.
4. Returns the results ofthe operations, with optional makerData to help the maker debug.</p>
<p>There are two ways to do the flashloan:</p>
<ol>
<li>balanceOf before/after</li>
<li>run transferFrom ourselves.</li>
</ol>
<h3>balanceOf pros:</h3>
<ul>
<li>maker may <code>transferFrom</code> another address they control; saves gas compared to dex’s <code>transferFrom</code></li>
<li>maker does not need to <code>approve</code> dex</li>
</ul>
<h3>balanceOf cons</h3>
<ul>
<li>if the ERC20 transfer method has a callback to receiver, the method does not work (the receiver can set its balance to 0 during the callback)</li>
<li>if the taker is malicious, they can analyze the maker code. If the maker goes on any dex2, they may execute code provided by the taker. This would reduce the taker balance and make the maker fail. So the taker could steal the maker’s balance.</li>
</ul>
<p>We choose <code>transferFrom</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1799
1800
1801
1802
1803</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">invertedFlashloan</span><span class="token punctuation">(</span>DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span><br>    <span class="token keyword">external</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span><br>  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>invertedFlashloan</code> must be used with a call (hence the <code>external</code> modifier) so its effect can be reverted. But a call from the outside would be fatal.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1805
1806
1807
1808</pre></code>
          <pre>    <span class="token keyword">require</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dex/invertedFlashloan/protected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    gasused <span class="token operator">=</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>sor<span class="token punctuation">,</span> taker<span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-maker-execute">Maker Execute</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1810
1811
1812
1813
1814
1815
1816</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">makerExecute</span><span class="token punctuation">(</span>DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">calldata</span> sor<span class="token punctuation">,</span> <span class="token builtin">address</span> taker<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> gasused<span class="token punctuation">)</span><br>  <span class="token punctuation">{</span><br>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span> abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>IMaker<span class="token punctuation">.</span>makerTrade<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> sor<span class="token punctuation">)</span><span class="token punctuation">;</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Calls an external function with controlled gas expense. A direct call of the form <code>(,bytes memory retdata) = maker.call{gas}(selector,...args)</code> enables a griefing attack: the maker uses half its gas to write in its memory, then reverts with that memory segment as argument. After a low-level call, solidity automaticaly copies <code>returndatasize</code> bytes of <code>returndata</code> into memory. So the total gas consumed to execute a failing offer could exceed <code>gasreq + overhead_gasbase/n + offer_gasbase</code> where <code>n</code> is the number of failing offers. This yul call only retrieves the first byte of the maker’s <code>returndata</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1818
1819
1820
1821
1822
1823</pre></code>
          <pre>    <span class="token builtin">uint</span> gasreq <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_gasreq</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">address</span> maker <span class="token operator">=</span> $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> retdata <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">bytes</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token builtin">bool</span> callSuccess<span class="token punctuation">;</span><br>    <span class="token builtin">bytes32</span> makerData<span class="token punctuation">;</span><br>    <span class="token builtin">uint</span> oldGas <span class="token operator">=</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We let the maker pay for the overhead of checking remaining gas and making the call. So the <code>require</code> below is just an approximation: if the overhead of (<code>require</code> + cost of <code>CALL</code>) is <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi></mrow><annotation encoding="application/x-tex">h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">h</span></span></span></span>, the maker will receive at worst <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>gasreq</mtext><mo>−</mo><mfrac><mrow><mn>63</mn><mi>h</mi></mrow><mn>64</mn></mfrac></mrow><annotation encoding="application/x-tex">\textrm{gasreq} - \frac{63h}{64}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7777700000000001em;vertical-align:-0.19444em;"></span><span class="mord text"><span class="mord textrm">gasreq</span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.2251079999999999em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801079999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">3</span><span class="mord mathnormal mtight">h</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> gas.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Note : as a possible future feature, we could stop an order when there’s not enough gas left to continue processing offers. This could be done safely by checking, as soon as we start processing an offer, whether <code>63/64(gasleft-overhead_gasbase-offer_gasbase) &gt; gasreq</code>. If no, we’d know by induction that there is enough gas left to apply fees, stitch offers, etc (or could revert safely if no offer has been taken yet).</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1826
1827
1828
1829
1830
1831
1832
1833
1834
1835
1836
1837
1838
1839
1840
1841
1842
1843
1844
1845
1846
1847
1848
1849
1850
1851
1852
1853
1854
1855
1856</pre></code>
          <pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>oldGas <span class="token operator">-</span> oldGas <span class="token operator">/</span> <span class="token number">64</span> <span class="token operator">>=</span> gasreq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"dex/notEnoughGasForMakerTrade"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token keyword">assembly</span> <span class="token punctuation">{</span><br>      callSuccess <span class="token operator">:=</span> <span class="token function">call</span><span class="token punctuation">(</span><br>        gasreq<span class="token punctuation">,</span><br>        maker<span class="token punctuation">,</span><br>        <span class="token number">0</span><span class="token punctuation">,</span><br>        <span class="token function">add</span><span class="token punctuation">(</span>cd<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">mload</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token function">add</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        <span class="token number">32</span><br>      <span class="token punctuation">)</span><br>      makerData <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>retdata<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>    gasused <span class="token operator">=</span> oldGas <span class="token operator">-</span> <span class="token function">gasleft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"dex/makerRevert"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br><br>    <span class="token builtin">bool</span> transferSuccess <span class="token operator">=</span> <span class="token function">transferToken</span><span class="token punctuation">(</span>sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span> maker<span class="token punctuation">,</span> taker<span class="token punctuation">,</span> sor<span class="token punctuation">.</span>wants<span class="token punctuation">)</span><span class="token punctuation">;</span><br><br>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>transferSuccess<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>      <span class="token function">innerRevert</span><span class="token punctuation">(</span><br>        <span class="token punctuation">[</span><span class="token builtin">bytes32</span><span class="token punctuation">(</span><span class="token string">"dex/makerTransferFail"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>gasused<span class="token punctuation">)</span><span class="token punctuation">,</span> makerData<span class="token punctuation">]</span><br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h2 id="dex.sol-misc.-functions">Misc. functions</h2>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre></pre></code>
          <pre></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>Regular solidity reverts prepend the string argument with a <a href="https://docs.soliditylang.org/en/v0.7.6/control-structures.html#revert">function signature</a>. Since we wish transfer data through a revert, the <code>innerRevert</code> function does a low-level revert with only the required data. <code>innerCode</code> decodes this data.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1860
1861
1862
1863
1864
1865
1866
1867
1868</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">innerDecode</span><span class="token punctuation">(</span><span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    <span class="token keyword">pure</span><br>    <span class="token keyword">returns</span> <span class="token punctuation">(</span><br>      <span class="token builtin">bytes32</span> errorCode<span class="token punctuation">,</span><br>      <span class="token builtin">uint</span> gasused<span class="token punctuation">,</span><br>      <span class="token builtin">bytes32</span> makerData<br>    <span class="token punctuation">)</span><br>  <span class="token punctuation">{</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>The <code>data</code> pointer is of the form <code>[3,errorCode,gasused,makerData]</code> where each array element is contiguous and has size 256 bits. 3 is added by solidity as the length of the rest of the data.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1870
1871
1872
1873
1874
1875
1876
1877
1878
1879
1880
1881
1882</pre></code>
          <pre>    <span class="token keyword">assembly</span> <span class="token punctuation">{</span><br>      errorCode <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      gasused <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>      makerData <span class="token operator">:=</span> <span class="token function">mload</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">innerRevert</span><span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token punctuation">{</span><br>    <span class="token keyword">assembly</span> <span class="token punctuation">{</span><br>      <span class="token keyword">revert</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">)</span><br>    <span class="token punctuation">}</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p><code>transferToken</code> is adapted from <a href="https://soliditydeveloper.com/safe-erc20">existing code</a> and in particular avoids the
“no return value” bug. It never throws and returns true iff the transfer was successful according to <code>tokenAddress</code>.</p>
<p>Note that any spurious exception due to an error in Dex code will be falsely blamed on <code>from</code>.</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1888
1889
1890
1891
1892
1893
1894
1895
1896
1897
1898
1899</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">transferToken</span><span class="token punctuation">(</span><br>    <span class="token builtin">address</span> tokenAddress<span class="token punctuation">,</span><br>    <span class="token builtin">address</span> <span class="token keyword">from</span><span class="token punctuation">,</span><br>    <span class="token builtin">address</span> to<span class="token punctuation">,</span><br>    <span class="token builtin">uint</span> value<br>  <span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token builtin">bytes</span> <span class="token keyword">memory</span> cd <span class="token operator">=</span><br>      abi<span class="token punctuation">.</span><span class="token function">encodeWithSelector</span><span class="token punctuation">(</span>IERC20<span class="token punctuation">.</span>transferFrom<span class="token punctuation">.</span>selector<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> to<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token punctuation">(</span><span class="token builtin">bool</span> noRevert<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">memory</span> data<span class="token punctuation">)</span> <span class="token operator">=</span> tokenAddress<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>cd<span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">return</span> <span class="token punctuation">(</span>noRevert <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> abi<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-abstract-functions">Abstract functions</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1901
1902
1903
1904
1905
1906
1907
1908
1909
1910</pre></code>
          <pre><br>  <span class="token keyword">function</span> <span class="token function">executeEnd</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    virtual<span class="token punctuation">;</span><br><br>  <span class="token keyword">function</span> <span class="token function">executeCallback</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    virtual<span class="token punctuation">;</span><br><span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><h1 id="dex.sol-fmd-and-ftd-instanciations-of-dex">FMD and FTD instanciations of Dex</h1>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1912
1913
1914
1915
1916
1917
1918
1919
1920
1921
1922
1923
1924
1925
1926
1927
1928
1929</pre></code>
          <pre><br><span class="token keyword">contract</span> <span class="token class-name">FMD</span> <span class="token keyword">is</span> Dex <span class="token punctuation">{</span><br>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasmax<span class="token punctuation">)</span> <span class="token function">Dex</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">,</span> gasmax<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"FMD"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">executeEnd</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    override<br>  <span class="token punctuation">{</span><span class="token punctuation">}</span><br><br>  <span class="token keyword">function</span> <span class="token function">executeCallback</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    override<br>  <span class="token punctuation">{</span><span class="token punctuation">}</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">contract</span> <span class="token class-name">FTD</span> <span class="token keyword">is</span> Dex <span class="token punctuation">{</span><br>  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token builtin">uint</span> gasprice<span class="token punctuation">,</span> <span class="token builtin">uint</span> gasmax<span class="token punctuation">)</span> <span class="token function">Dex</span><span class="token punctuation">(</span>gasprice<span class="token punctuation">,</span> gasmax<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token string">"FTD"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="lineComment"><p>execute taker trade</p>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1931
1932
1933
1934
1935
1936
1937
1938
1939
1940
1941
1942</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">executeEnd</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    override<br>  <span class="token punctuation">{</span><br>    <span class="token function">ITaker</span><span class="token punctuation">(</span>mor<span class="token punctuation">.</span>taker<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">takerTrade</span><span class="token punctuation">(</span><br>      sor<span class="token punctuation">.</span>base<span class="token punctuation">,</span><br>      sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>      mor<span class="token punctuation">.</span>totalGot<span class="token punctuation">,</span><br>      mor<span class="token punctuation">.</span>totalGave<br>    <span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
    <div class="level">
      <div class="left-background"></div>
      <div class="hover-background"></div>
      <div class="left">
        <div class="blockComment"><p>We use <code>transferFrom</code> with takers (instead of checking <code>balanceOf</code> before/after the call) for the following reason we want the taker to be awaken after all loans have been made, so either</p>
<ol>
<li>The taker gets a list of all makers and loops through them to pay back, or</li>
<li>we call a new taker method “payback” after returning from each maker call, or</li>
<li>we call transferFrom after returning from each maker call</li>
</ol>
<p>So :</p>
<ol>
<li>Would mean accumulating a list of all makers, which would make the market order code too complex</li>
<li>Is OK, but has an extra CALL cost on top of the token transfer, one for each maker. This is unavoidable anyway when calling makerTrade (since the maker must be able to execute arbitrary code at that moment), but we can skip it here.</li>
<li>Is the cheapest, but it has the drawbacks of <code>transferFrom</code>: money must end up owned by the taker, and taker needs to <code>approve</code> Dex</li>
</ol>
</div>
      </div>
      <code class="right solidity">
        <div class="codewrap">
          <code class="lines"><pre>1953
1954
1955
1956
1957
1958
1959
1960
1961
1962
1963
1964
1965
1966</pre></code>
          <pre>  <span class="token keyword">function</span> <span class="token function">executeCallback</span><span class="token punctuation">(</span>MultiOrder <span class="token keyword">memory</span> mor<span class="token punctuation">,</span> DC<span class="token punctuation">.</span>SingleOrder <span class="token keyword">memory</span> sor<span class="token punctuation">)</span><br>    <span class="token keyword">internal</span><br>    override<br>  <span class="token punctuation">{</span><br>    <span class="token builtin">bool</span> success <span class="token operator">=</span><br>      <span class="token function">transferToken</span><span class="token punctuation">(</span><br>        sor<span class="token punctuation">.</span>quote<span class="token punctuation">,</span><br>        mor<span class="token punctuation">.</span>taker<span class="token punctuation">,</span><br>        $$<span class="token punctuation">(</span><span class="token function">offerDetail_maker</span><span class="token punctuation">(</span><span class="token string">"sor.offerDetail"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>        sor<span class="token punctuation">.</span>gives<br>      <span class="token punctuation">)</span><span class="token punctuation">;</span><br>    <span class="token keyword">require</span><span class="token punctuation">(</span>success<span class="token punctuation">,</span> <span class="token string">"dex/takerFailToPayMaker"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><span class="token punctuation">}</span></pre>
        </div>
        <div class="focuser">
          <div class="focus-icon"><!--⥮--></div>
          <div class="warning-overlay"></div>
        </div>
      </code>
    </div>
  </main>
  </body>
</html>
